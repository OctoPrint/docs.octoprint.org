.. _sec-api-general:

*******************
General information
*******************

.. _sec-api-general-authorization:

Authorization
=============

Unless there is an active session established, OctoPrint's API expects an API key to be supplied with each request. This API
key can be either the globally configured one, a user specific one or an app and user specific one as generated by the
authorization workflow implemented by the bundled :ref:`Application Keys Plugin <sec-bundledplugins-appkeys>` (since 1.3.10).

Clients are advised to implement the :ref:`Application Keys Plugin workflow <sec-bundledplugins-appkeys-workflow>` first and
fallback on directing the user to manually supply the the user specific API key. The global key is deprecated, will be removed 
in 1.13.0 and should no longer be used.

The API key must either be supplied in the custom HTTP header ``X-Api-Key``, e.g.

.. sourcecode:: http

   GET /api/files HTTP/1.1
   Host: example.com
   X-Api-Key: abcdef...

or as a ``Bearer`` token in the ``Authorization`` header, e.g.

.. sourcecode:: http

   GET /api/files HTTP/1.1
   Host: example.com
   Authorization: Bearer abcdef...

For testing purposes it is also possible to supply the API key via a query parameter ``apikey``, e.g.

.. sourcecode:: http

   GET /api/files?apikey=abcdef... HTTP/1.1
   Host: example.com

Please be advised that clients should use the header field variant if at all possible.

If the key is missing or invalid, OctoPrint will treat the request as it would any unauthenticated anonymous request to the endpoint.
That means that any requests without or with an invalid API key targeting other API endpoints than :ref:`Login <sec-api-authentication-login>`
will be denied with a :http:statuscode:`403`.

.. _fig-api-general-changepassword:
.. figure:: ../images/usersettings-api-key.png
   :align: center
   :alt: API key options in the User Settings

   The API key options in the User Settings. Users can generate and revoke their custom API key here.

.. _fig-api-general-globalapikey:
.. figure:: ../images/settings-global-api-key.png
   :align: center
   :alt: Global API key in the API settings

   The global API key can be found in the "API" settings. However, it is deprecated and will be removed in 1.13.0.

.. _sec-api-general-versioning:

API Versioning
==============

.. versionadded:: 1.12.0

OctoPrint supports requesting a certain API version on requests by setting the ``X-OctoPrint-Api-Version`` header
accordingly. API versions hereby the implementation as present in OctoPrint's server versions.

If the header is left out, the API will behave according to its documented pre-1.12.0 behaviour. If the header is set, the API will 
follow the behaviour found in that OctoPrint version.

Example without explicit version:

.. sourcecode:: http

   GET /api/version HTTP/1.1
   Host: example.com
   Authorization: Bearer abcdef...

.. sourcecode:: http

   HTTP/1.1 200 OK
   Content-Type: application/json

   {
     "api": "0.1",
     "server": "1.12.0",
     "text": "OctoPrint 1.12.0"
   }

Example with a requested API version of 1.12.0:

.. sourcecode:: http

   GET /api/version HTTP/1.1
   Host: example.com
   Authorization: Bearer abcdef...
   X-OctoPrint-Api-Version: 1.12.0

.. sourcecode:: http

   HTTP/1.1 200 OK
   Content-Type: application/json

   {
     "server": "1.12.0",
     "text": "OctoPrint 1.12.0"
   }

Clients should move to defining the specific versions they support from now on, to make it possible to implement new functionality in
OctoPrint that requires API changes without breaking existing third party software.

.. _sec-api-general-contenttype:

Content Type
============

If not otherwise stated, OctoPrint's API expects request bodies and issues response bodies as ``Content-Type: application/json``.

.. _sec-api-general-encoding:

Encoding
========

OctoPrint uses UTF-8 as charset.

That also includes headers in ``multipart/form-data`` requests, in order to allow the full UTF-8 range of characters
for uploaded filenames. If a ``multipart/form-data`` sub header cannot be decoded as UTF-8, OctoPrint will also attempt
to decode it as ISO-8859-1.

Additionally, OctoPrint supports replacing the ``filename`` field in the ``Content-Disposition`` header of a
multipart field with a ``filename*`` field following `RFC 5987, Section 3.2 <https://tools.ietf.org/html/rfc5987#section-3.2>`_,
which allows defining the charset used for encoding the filename. If both ``filename`` and ``filename*`` fields are
present, following the recommendation of the RFC ``filename*`` will be used.

For an example on how to send a request utilizing RFC 5987 for the ``filename*`` attribute, see the second example
in :ref:`Upload file <sec-api-fileops-uploadfile>`.

.. _sec-api-general-crossorigin:

Cross-origin requests
=====================

To make use of the OctoPrint API from websites other than the OctoPrint web interface,
cross-origin resource sharing (`CORS <http://en.wikipedia.org/wiki/Cross-origin_resource_sharing>`_) must be enabled.
This is the case even when the website in question is served from a different port on the same machine and on localhost.

To enable this feature, set the ``allowCrossOrigin`` key of the ``api`` section in ``config.yml`` to ``true`` or
check the corresponding checkbox in the API settings dialog (see :numref:`fig-api-general-globalapikey`).

.. code-block:: yaml

   api:
     allowCrossOrigin: true

.. warning::

   This means any browser page can send requests to the OctoPrint API. Authorization via an API-Key is still required however.

If CORS is not enabled you will get errors like the following::

   XMLHttpRequest cannot load http://localhost:8081/api/files. No 'Access-Control-Allow-Origin'
   header is present on the requested resource.


.. note::

   For security reasons, OctoPrint will not set the ``Access-Control-Allow-Credentials``
   header, even if CORS support is enabled. That means that cookies will not be sent by
   the browser to OctoPrint, effectively making it impossible to authenticate through
   the login mechanism (or reusing an existing login session). When accessing OctoPrint
   via CORS, you'll therefore always need to use an API key.

.. _sec-api-general-csrf:

CSRF Protection
===============

.. versionadded:: 1.8.3

To protect OctoPrint against `CSRF attacks <https://owasp.org/www-community/attacks/csrf>`_ against the non CORS affected upload endpoints, in case of browser session based authorization the API
is protected using the `Double Submit Cookie mitigation strategy <https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html#double-submit-cookie>`_.
On first page load of the UI, the login page or the recovery page, a ``csrf_token_P<port>`` or ``csrf_token_P<port>_R<root>`` cookie is set
that can be read via client-side JavaScript. All requests towards the API that are not ``GET``, ``HEAD`` or ``OPTIONS``
and rely on cookie based authorization (so not on an API key but rather an active login session) are required
to send both the ``csrf_token`` cookie as well as an ``X-CSRF-Token`` header containing its value.

.. note::

   If you use the :ref:`JS Client library <sec-jsclientlib>`, this will take care of doing the needful for you. Any code in the *Core UI* calling
   API functions through ``$.ajax`` or ``$.get`` or ``$.post`` will also take care of this for you. If you use another library for
   accessing OctoPrint's API in a browser context, you'll need to make sure to send the ``X-CSRF-Token`` header yourself. Examples for
   several JS frameworks can be found in the `OWASP cheatsheet on CSRF attacks <https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html#javascript-guidance-for-auto-inclusion-of-csrf-tokens-as-an-ajax-request-header>`_.
   Take a look at the implementations of ``OctoPrintClient.getCookie`` and ``OctoPrintClient.getHeaders`` in ``src/octoprint/static/js/client/base.js``
   for details on how to retrieve the cookie value and how to construct the header.

