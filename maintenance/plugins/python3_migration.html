

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Migrating to Python 3 &mdash; OctoPrint maintenance documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script src="https://unpkg.com/mermaid@8.4.8/dist/mermaid.min.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Internal Modules" href="../modules/index.html" />
    <link rel="prev" title="Distributing your plugin" href="distributing.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> OctoPrint
          

          
          </a>

          
            
            
              <div class="version">
                maintenance
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../features/index.html">Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bundledplugins/index.html">Bundled Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../configuration/index.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/index.html">REST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../events/index.html">Events</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development/index.html">Development</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Developing Plugins</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="concepts.html">General Concepts</a></li>
<li class="toctree-l2"><a class="reference internal" href="controlproperties.html">Control Properties</a></li>
<li class="toctree-l2"><a class="reference internal" href="mixins.html">Mixins</a></li>
<li class="toctree-l2"><a class="reference internal" href="hooks.html">Hooks</a></li>
<li class="toctree-l2"><a class="reference internal" href="helpers.html">Helpers</a></li>
<li class="toctree-l2"><a class="reference internal" href="injectedproperties.html">Injected Properties</a></li>
<li class="toctree-l2"><a class="reference internal" href="viewmodels.html">Viewmodels</a></li>
<li class="toctree-l2"><a class="reference internal" href="gettingstarted.html">Plugin Tutorial</a></li>
<li class="toctree-l2"><a class="reference internal" href="distributing.html">Distributing your plugin</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Migrating to Python 3</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#how-to-get-a-python-3-virtual-environment-with-octoprint">How to get a Python 3 virtual environment with OctoPrint</a></li>
<li class="toctree-l3"><a class="reference internal" href="#telling-octoprint-your-plugin-is-python-3-ready">Telling OctoPrint your plugin is Python 3 ready</a></li>
<li class="toctree-l3"><a class="reference internal" href="#common-pitfalls-during-migration">Common pitfalls during migration</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#bytes-vs-unicode">Bytes vs unicode</a></li>
<li class="toctree-l4"><a class="reference internal" href="#absolute-imports">Absolute imports</a></li>
<li class="toctree-l4"><a class="reference internal" href="#version-specific-imports">Version specific imports</a></li>
<li class="toctree-l4"><a class="reference internal" href="#integer-division">Integer division</a></li>
<li class="toctree-l4"><a class="reference internal" href="#iterators-instead-of-list-from-map-filter-zip">Iterators instead of list from map, filter, zip</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#checklist">Checklist</a></li>
<li class="toctree-l3"><a class="reference internal" href="#further-reading">Further reading</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../modules/index.html">Internal Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../jsclientlib/index.html">JavaScript Client Library</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">OctoPrint</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">


  <p style="padding: 10px;margin: 0 0 10px 0;border-radius: 2px;letter-spacing: 1px;font-size: 13px;color: white;text-align: center;background: #3a87ad;background-image: none;background-size: auto;background-size: 28px 28px;background-image: linear-gradient( -45deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.2) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, 0.2) 50%, rgba(255, 255, 255, 0.2) 75%, transparent 75%, transparent );">
    <strong>Note:</strong>
    These are not the docs of the latest released version. Those can be found <a href="https://docs.octoprint.org/en/1.4.0" style="color: white;text-decoration: underline">here</a>.
  </p>


  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Developing Plugins</a> &raquo;</li>
        
      <li>Migrating to Python 3</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/plugins/python3_migration.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="migrating-to-python-3">
<span id="sec-plugins-python3"></span><h1>Migrating to Python 3<a class="headerlink" href="#migrating-to-python-3" title="Permalink to this headline">¶</a></h1>
<p>Python 2 is now EOL as of January 1st 2020. With the release of 1.4.0 OctoPrint will be compatible to both Python 2 and
Python 3.</p>
<p>However, the same doesn’t automatically hold true for all of the third party plugins for OctoPrint out there - it will
fall to their authors to ensure compatibility to both Python versions.</p>
<p>This guide is supposed to help plugin authors in making sure their plugins run under Python 2 as well as Python 3,
which for now is the goal for OctoPrint’s ecosystem, as we’ll have to live with existing legacy Python 2 installations
for a while to come (the plan is to stay Python 2 compatible until roughly a year after the release of 1.4.0).</p>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#how-to-get-a-python-3-virtual-environment-with-octoprint" id="id1">How to get a Python 3 virtual environment with OctoPrint</a></p></li>
<li><p><a class="reference internal" href="#telling-octoprint-your-plugin-is-python-3-ready" id="id2">Telling OctoPrint your plugin is Python 3 ready</a></p></li>
<li><p><a class="reference internal" href="#common-pitfalls-during-migration" id="id3">Common pitfalls during migration</a></p>
<ul>
<li><p><a class="reference internal" href="#bytes-vs-unicode" id="id4">Bytes vs unicode</a></p></li>
<li><p><a class="reference internal" href="#absolute-imports" id="id5">Absolute imports</a></p></li>
<li><p><a class="reference internal" href="#version-specific-imports" id="id6">Version specific imports</a></p></li>
<li><p><a class="reference internal" href="#integer-division" id="id7">Integer division</a></p></li>
<li><p><a class="reference internal" href="#iterators-instead-of-list-from-map-filter-zip" id="id8">Iterators instead of list from map, filter, zip</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#checklist" id="id9">Checklist</a></p></li>
<li><p><a class="reference internal" href="#further-reading" id="id10">Further reading</a></p></li>
</ul>
</div>
<div class="section" id="how-to-get-a-python-3-virtual-environment-with-octoprint">
<span id="sec-plugins-python3-venv"></span><h2><a class="toc-backref" href="#id1">How to get a Python 3 virtual environment with OctoPrint</a><a class="headerlink" href="#how-to-get-a-python-3-virtual-environment-with-octoprint" title="Permalink to this headline">¶</a></h2>
<p>In order to test your plugins for Python 3 compatibility and also to allow for ongoing maintenance against both Python
versions, you should create a Python 3 virtual environment next to your Python 2 one. You can then quickly switch between
Python 2 and Python 3 simply by <code class="docutils literal notranslate"><span class="pre">activate</span></code>-ing whichever one you need.</p>
<p>You can create a Python 3 virtualenv next to your (existing) Python 2 virtualenv and then just activate which one you
currently want to use.</p>
<p>After installing Python 3 on your development system it’s as easy as supplying <code class="docutils literal notranslate"><span class="pre">--python=/path/to/python3executable</span></code>
to <code class="docutils literal notranslate"><span class="pre">virtualenv</span></code>, e.g.:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>virtualenv --python=/usr/bin/python3 venv3
</pre></div>
</div>
<p>That will have the virtualenv be created based on Python 3, regardless of whether it’s currently running under Python
2 or 3. The same works for Python 2 btw:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>virtualenv --python=/usr/bin/python2 venv2
</pre></div>
</div>
<p>After creating the virtual environment, make sure to activate &amp; install OctoPrint into it:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>source venv3/bin/activate
pip install &quot;OctoPrint&gt;=1.4.0rc1&quot;
</pre></div>
</div>
<p>Then create an editable install of your plugin, start the server and start testing:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>pip install -e path/to/your/plugin
octoprint serve --debug
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>On Windows that will probably look something like this instead:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>virtualenv --python=C:/Python37/python.exe venv37
venv3/Script/activate.bat
pip install &quot;OctoPrint&gt;=1.4.0rc1&quot;
pip install -e path/to/your/plugin
octoprint serve --debug
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you want to migrate your existing OctoPrint install <em>on OctoPi 0.17.0</em> to Python 3, I suggest to first make a
<a class="reference internal" href="../bundledplugins/backup.html#sec-bundledplugins-backup"><span class="std std-ref">backup</span></a>, then move the existing venv <code class="docutils literal notranslate"><span class="pre">/home/pi/oprint</span></code> out of the way and
create a new one based on Python 3 (which should already be present on current OctoPi images):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>mv ~/oprint ~/oprint.py2
virtualenv --python=/usr/bin/python3 oprint
source ~/oprint/bin/activate
pip install &quot;OctoPrint&gt;=1.4.0&quot;
sudo service octoprint restart
</pre></div>
</div>
</div>
</div>
<div class="section" id="telling-octoprint-your-plugin-is-python-3-ready">
<span id="sec-plugins-python3-markup"></span><h2><a class="toc-backref" href="#id2">Telling OctoPrint your plugin is Python 3 ready</a><a class="headerlink" href="#telling-octoprint-your-plugin-is-python-3-ready" title="Permalink to this headline">¶</a></h2>
<p>In order for OctoPrint to even load your plugin when it’s running under Python 3, it first needs to know your plugin is
compatible to a Python 3 environment. By default OctoPrint will assume your plugin isn’t and refuse to load it when
running under Python 3 itself.</p>
<p>To tell OctoPrint about this, all you need is to set the <code class="docutils literal notranslate"><span class="pre">__plugin_pythoncompat__</span></code> property in your plugins’s <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code>
accordingly, e.g.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">__plugin_pythoncompat__</span> <span class="o">=</span> <span class="s2">&quot;&gt;=2.7,&lt;4&quot;</span>
</pre></div>
</div>
<p>This would tell OctoPrint that your plugin is compatible to all Python versions between 2.7 and 3.x. This should be
your target compatibility range for now.</p>
<p>If at a later date you want to go all-in on Python 3 and mark your plugin as no longer supporting Python 2, tell
OctoPrint about this as well:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">__plugin_pythoncompat__</span> <span class="o">=</span> <span class="s2">&quot;&gt;=3,&lt;4&quot;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You can also tell OctoPrint to ignore the Python compatibility flags for a specific plugin via <cite>config.yaml</cite>:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">plugins</span><span class="p">:</span>
  <span class="nt">_forcedCompatible</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="s">&quot;myplugin&quot;</span>
  <span class="p p-Indicator">-</span> <span class="s">&quot;anotherplugin&quot;</span>
</pre></div>
</div>
<p>Note that this should only be used temporarily during testing and migration, or to mark an important plugin
not under your own control that actually works fine under Python 3 out of the box as compatible while waiting
until the plugin author has pushed an update including the needed flags. Do not just blindly mark third party
plugins as compatible and then open support requests if that causes issues in your setup.</p>
</div>
<p>Once your plugin is ensured to be compatible and you’ve released a new version that includes the necessary compatibility
flag and changes, is done you also need to mark up your plugin in the Official Plugin Repository (if it’s registered
therein) so that OctoPrint’s built-in Plugin Manager will see that your plugin is compatible as well and allow users
to install it through it. In order to do that, you need to add a new flag compatibility.python to the front matter in
your plugin registration file and file a pull request for that. Adjust the markdown file so that it contains this:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">compatibility</span><span class="p">:</span>
  <span class="nt">python</span><span class="p">:</span> <span class="s">&quot;&gt;=2.7,&lt;3&quot;</span>
</pre></div>
</div>
<p>The value here follows the same mechanism as the <code class="docutils literal notranslate"><span class="pre">__plugin_pythoncompat__</span></code> property, so <code class="docutils literal notranslate"><span class="pre">&gt;=2.7,&lt;3</span></code> for 2 and 3
support and <code class="docutils literal notranslate"><span class="pre">&gt;=3,&lt;4</span></code> for 3+ support.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Do <strong>not</strong> just mark your plugin as compatible without diligent testing that it actually does work as expected and
without flooding <code class="docutils literal notranslate"><span class="pre">octoprint.log</span></code> with warnings and errors!</p>
</div>
</div>
<div class="section" id="common-pitfalls-during-migration">
<span id="sec-plugins-python3-pitfalls"></span><h2><a class="toc-backref" href="#id3">Common pitfalls during migration</a><a class="headerlink" href="#common-pitfalls-during-migration" title="Permalink to this headline">¶</a></h2>
<p>Some of the changes in Python 3 compared to Python 2 are sadly backwards incompatible and usually cause a number of
common issues in code written for Python 2 when run under Python 3. By now they are pretty well documented and there
exist a number of helpful and comprehensive migration guides, three of which I want to mention here.</p>
<p>One is the official Python 3 porting guide <a class="reference external" href="https://docs.python.org/3/howto/pyporting.html">Porting Python 2 Code to Python 3</a>
which sums up all the important changes and also gives hints on how best to go about running a project which supports
both versions for now.</p>
<p>The second is the <a class="reference external" href="https://python-future.org/compatible_idioms.html">Writing Python 2-3 compatible code</a> cheat sheet
from the Python-Future project, which is a comprehensive list of idioms that are compatible to both Python 2 and 3 and
will make your code run under both, utilizing <a class="reference external" href="https://python-future.org/">future</a> and <a class="reference external" href="https://six.readthedocs.io/">six</a>.
I can strongly recommend this cheat sheet, it’s what primarily guided me during the migration phase as well.</p>
<p>The third one is the free online book <a class="reference external" href="http://python3porting.com/toc.html">Support Python 3: An in-depth guide</a>, and
especially its chapter on <a class="reference external" href="http://python3porting.com/problems.html">Common migration problems</a> in which you’ll find
extensive descriptions of the most troublesome changes in Python 3 and how to overcome them. Please note that with
regards to the contents of this book, we are aiming for the “Python 2 and Python 3 without conversion” strategy, so
code that runs in both environments. Sadly this book is a bit outdated by now and still references some long-out versions
as “upcoming”, so with regards to compatible idioms to use, best stick to the Python-Future cheat sheet.</p>
<p>Looking at the issues encountered by some plugin authors and also my own experiences during the Python 3 migration of
OctoPrint’s code, the most common problems for these scenarios seem to be byte vs unicode issues, trouble with absolute
imports, changes in integer division behaviour and the switch of map, filter and zip to return iterators instead of
lists and causing issues in the following code due to that.</p>
<div class="section" id="bytes-vs-unicode">
<span id="sec-plugins-python3-pitfalls-strings"></span><h3><a class="toc-backref" href="#id4">Bytes vs unicode</a><a class="headerlink" href="#bytes-vs-unicode" title="Permalink to this headline">¶</a></h3>
<p>One of if not the most problematic change between Python 2 and 3 surely must be the change in string handling. Under
Python 2 your basic string was a byte string, but it could also magically turn into a unicode string depending on what
you wrote into it. That did cause some confusion, especially in APIs, and caused quite a mess, which is why the decision
was made to go for distinct text and binary types instead, and making the string literal always be a (unicode) text.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Please note that these changes in string handling also affect several Python APIs that operate on files and streams
and thus might also affect parts of OctoPrint’s plugin interface that inherit from these APIs. Currently only one such
case has been reported, as OctoPrint’s <a class="reference internal" href="../modules/filemanager.html#octoprint.filemanager.util.LineProcessorStream" title="octoprint.filemanager.util.LineProcessorStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">LineProcessorStream</span></code></a> will return bytes
instead of str on its <code class="docutils literal notranslate"><span class="pre">process_line</span></code> function under Python 3 - so here’s a heads-up if your plugin happens to utilize that.</p>
</div>
<p>Obviously, that will lead to issues in code using “just strings” when run under Python 2 vs 3. The first step to solve
these problems would be to make your scripts behave the same under Python 2 and 3 by putting this right at the top of
all your plugin’s python files:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">unicode_literals</span>
</pre></div>
</div>
<p>That will make your files behave as if they were running under Python 3, even when run under Python 2, and your string
literals will now be the text data type, which - annoyingly - is a different one under Python 2 vs 3, <code class="docutils literal notranslate"><span class="pre">unicode</span></code> vs <code class="docutils literal notranslate"><span class="pre">str</span></code> to
be exact. Heads-up here - under Python 2 there’s also a <code class="docutils literal notranslate"><span class="pre">str</span></code> type, but that one is for binary data. Yes, I know, this
ain’t fun.</p>
<p>In any case, once you’ve done this, make sure that everything in your code that should be text is text (<code class="docutils literal notranslate"><span class="pre">unicode</span></code> under
Python 2, <code class="docutils literal notranslate"><span class="pre">str</span></code> under Python 3), and everything that should be binary is binary (<code class="docutils literal notranslate"><span class="pre">str</span></code> under Python 2, <code class="docutils literal notranslate"><span class="pre">bytes</span></code> under Python 3).
A good rule of thumb is that you usually want to use text as much as possible within your application and only convert
to/from bytes at the outskirts, e.g. when writing to a file, a socket or something else machine like. Note that you do
NOT need to convert to bytes when implementing API endpoints that return JSON, as that should use text with unicode
anyhow.</p>
<p>OctoPrint includes two utility methods you should use to ensure your strings enter/exit your code in the right format,
under both Python versions: <a class="reference internal" href="../modules/util.html#octoprint.util.to_bytes" title="octoprint.util.to_bytes"><code class="xref py py-func docutils literal notranslate"><span class="pre">octoprint.util.to_bytes()</span></code></a> and <a class="reference internal" href="../modules/util.html#octoprint.util.to_unicode" title="octoprint.util.to_unicode"><code class="xref py py-func docutils literal notranslate"><span class="pre">octoprint.util.to_unicode()</span></code></a>. Use them to ensure the correct data
types and to avoid weird conversion and encoding issues during runtime.</p>
<p>You can read more about this specific issue in the corresponding section of the
<a class="reference external" href="https://docs.python.org/3/howto/pyporting.html#text-versus-binary-data">Python porting guide</a> and also in the
<a class="reference external" href="https://python-future.org/compatible_idioms.html#strings-and-bytes">cheat sheet</a>.</p>
</div>
<div class="section" id="absolute-imports">
<span id="sec-plugins-python3-pitfalls-absolute-imports"></span><h3><a class="toc-backref" href="#id5">Absolute imports</a><a class="headerlink" href="#absolute-imports" title="Permalink to this headline">¶</a></h3>
<p>Python 3 now defaults to absolute imports, meaning that trying to import a sub package with a</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">my_sub_package</span>
</pre></div>
</div>
<p>will now fail with an error. You’ll need to explicitly make the import a relative one:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">my_sub_package</span>
</pre></div>
</div>
<p>To make your code behave the same in that regard unter both Python 2 and Python 3, you should add the corresponding
future import:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_imports</span>
</pre></div>
</div>
<p>You can read more about this specific issue in the
<a class="reference external" href="https://python-future.org/compatible_idioms.html#imports-relative-to-a-package">cheat sheet</a> and also in
<a class="reference external" href="http://python3porting.com/problems.html#relative-import-problems">the book</a>.</p>
</div>
<div class="section" id="version-specific-imports">
<span id="sec-plugins-python3-pitfalls-version-specific-imports"></span><h3><a class="toc-backref" href="#id6">Version specific imports</a><a class="headerlink" href="#version-specific-imports" title="Permalink to this headline">¶</a></h3>
<p>Sometimes it is necessary to use an import statement that is explicitly related to a specific Python version, e.g. due to
a package change between Python 2 and 3. You can do this by first trying the Python 3 import and if that doesn’t work
out trying the Python 2 import instead:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
   <span class="kn">import</span> <span class="nn">queue</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
   <span class="kn">import</span> <span class="nn">Queue</span> <span class="k">as</span> <span class="nn">queue</span>
</pre></div>
</div>
<p>This should be the preferred method of handling situations like this. If you actually do need to do explicit version
specific imports that cannot be handled this way, you can check for the Python version like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;2&#39;</span><span class="p">:</span>
   <span class="c1"># Python 2 specific imports</span>
<span class="k">else</span><span class="p">:</span>
   <span class="c1"># Python 3 specific imports</span>
</pre></div>
</div>
</div>
<div class="section" id="integer-division">
<span id="sec-plugins-python3-pitfalls-intdiv"></span><h3><a class="toc-backref" href="#id7">Integer division</a><a class="headerlink" href="#integer-division" title="Permalink to this headline">¶</a></h3>
<p>When you divide two integers in Python 2 you’ll get back an integer, rounded down. In Python 3 however you’ll now get
a float. That means you might have to revisit some places where you do integer divisions and might rely on the result
to be an integer as well (e.g. when using a calculation result as an index in an array or something like that).</p>
<p>Yet again there’s a future-import to apply to your files in order to at least have them behave the same in that regard
under both Python 2 and Python 3:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>
</pre></div>
</div>
<p>You can read more about this specific issue in the <a class="reference external" href="https://docs.python.org/3/howto/pyporting.html#division">Python porting guide</a>
and in the <a class="reference external" href="https://python-future.org/compatible_idioms.html#division">cheat sheet</a>.</p>
</div>
<div class="section" id="iterators-instead-of-list-from-map-filter-zip">
<span id="sec-plugins-python3-pitfalls-iterators"></span><h3><a class="toc-backref" href="#id8">Iterators instead of list from map, filter, zip</a><a class="headerlink" href="#iterators-instead-of-list-from-map-filter-zip" title="Permalink to this headline">¶</a></h3>
<p>The built-in functions <code class="docutils literal notranslate"><span class="pre">map</span></code>, <code class="docutils literal notranslate"><span class="pre">filter</span></code> and <code class="docutils literal notranslate"><span class="pre">zip</span></code> return a <code class="docutils literal notranslate"><span class="pre">list</span></code> with their result in Python 2. In Python 3 they have been
switched to returning iterators. That can cause trouble with code handling the result (e.g. if you try to return it as
part of a JSON response on an API endpoint).</p>
<p>The easiest way to solve this is to make sure to wrap any <code class="docutils literal notranslate"><span class="pre">map</span></code>/<code class="docutils literal notranslate"><span class="pre">filter</span></code>/<code class="docutils literal notranslate"><span class="pre">zip</span></code> calls into a <code class="docutils literal notranslate"><span class="pre">list</span></code> constructor if the result is
to be used outside of the calling code (even though that comes with a small performance penalty under Python 2):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">result1</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">my_collection</span><span class="p">)</span>
<span class="n">result2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">my_collection</span><span class="p">))</span>

<span class="k">assert</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">result1</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span> <span class="c1"># Python 2 passes, Python 3 fails</span>
<span class="k">assert</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">result2</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span> <span class="c1"># Python 2 and 3 pass</span>
</pre></div>
</div>
<p>There also exist further options, take a look at the <a class="reference external" href="https://python-future.org/compatible_idioms.html#map">cheat sheet</a>.</p>
</div>
</div>
<div class="section" id="checklist">
<span id="sec-plugins-python3-checklist"></span><h2><a class="toc-backref" href="#id9">Checklist</a><a class="headerlink" href="#checklist" title="Permalink to this headline">¶</a></h2>
<p>As a summary, follow this checklist to migrate your plugin to be compatible to both Python 2 and 3:</p>
<blockquote>
<div><ul>
<li><p>Create a Python 3 virtualenv and install OctoPrint and your plugin into it for testing.</p></li>
<li><p>Tell OctoPrint your plugin is Python 2 and 3 compatible by adding a new property <code class="docutils literal notranslate"><span class="pre">__plugin_pycompat__</span></code> to its
<code class="docutils literal notranslate"><span class="pre">__init__.py</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">__plugin_pythoncompat__</span> <span class="o">=</span> <span class="s2">&quot;&gt;=2.7,&lt;4&quot;</span>
</pre></div>
</div>
</li>
<li><p>Add a compatibility header to all <cite>py</cite> files to ensure similar basic behaviour under Python 2 and Python 3:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">unicode_literals</span>
</pre></div>
</div>
</li>
<li><p>Thorougly test your plugin under Python 3. Pay special attention to any kind of string handling issues, integer
division, relative imports from your plugin package and how the results of <code class="docutils literal notranslate"><span class="pre">map</span></code>, <code class="docutils literal notranslate"><span class="pre">filter</span></code> and <code class="docutils literal notranslate"><span class="pre">zip</span></code> are
used in your code, as those have proven to be the biggest issues during past migrations.</p></li>
<li><p>Once everything works under both Python versions and you’ve prepared a new release of your plugin (don’t forget to
increment the version!), update your registration file in the Official Plugin Repository to include the correct
Python compatibility information as well:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">compatibility</span><span class="p">:</span>
  <span class="nt">python</span><span class="p">:</span> <span class="s">&quot;&gt;=2.7,&lt;4&quot;</span>
</pre></div>
</div>
</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="further-reading">
<span id="sec-plugins-python3-furtherreading"></span><h2><a class="toc-backref" href="#id10">Further reading</a><a class="headerlink" href="#further-reading" title="Permalink to this headline">¶</a></h2>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<dl class="simple">
<dt><a class="reference external" href="https://docs.python.org/3/howto/pyporting.html">Porting Python 2 Code to Python 3</a></dt><dd><p>The official Python 3 porting guide which sums up all the important changes and also gives hints on how best to
go about running a project which supports both versions for now.</p>
</dd>
<dt><a class="reference external" href="https://python-future.org/compatible_idioms.html">Cheat Sheet: Writing Python 2-3 compatible code</a></dt><dd><p>A comprehensive list of idioms that are compatible to both Python 2 and 3 and will make your code run under both,
utilizing <a class="reference external" href="https://python-future.org/">future</a> and <a class="reference external" href="https://six.readthedocs.io/">six</a>. Strongly recommended.</p>
</dd>
<dt><a class="reference external" href="http://python3porting.com/bookindex.html">Supporting Python 3: An in-depth guide</a></dt><dd><p>A free online book on the switch to Python 3. Sadly seems a bit outdated by now, so with regards to compatible
idioms to use, best stick to the cheat sheet. Gives some interesting background however.</p>
</dd>
<dt><a class="reference external" href="https://community.octoprint.org/t/towards-python-3-and-octoprint-1-4-0/12382?u=foosel">Towards Python 3 and OctoPrint 1.4.0</a></dt><dd><p>Forum topic discussing OctoPrint 1.4.0’s roadmap including Python 3 compatibility and time frame.</p>
</dd>
<dt><a class="reference external" href="https://community.octoprint.org/t/migrating-plugins-to-python-2-3-compatibility-experiences/16294?u=foosel">Migrating plugins to Python 2 &amp; 3 compatibility - experiences?</a></dt><dd><p>Forum topic collecting experiences by plugin developers in migrating their plugins to achieve Python 2 &amp; 3
compatibility.</p>
</dd>
</dl>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../modules/index.html" class="btn btn-neutral float-right" title="Internal Modules" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="distributing.html" class="btn btn-neutral float-left" title="Distributing your plugin" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2013-2020, Gina Häußge

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Other Versions</span>
    v: maintenance
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl>
      <dt>Tags</dt>
      <dd><a href="https://docs.octoprint.org/en/1.3.12/plugins/python3_migration.html">1.3.12</a></dd>
      <dd><a href="https://docs.octoprint.org/en/1.4.0/plugins/python3_migration.html">1.4.0</a></dd>
      <dd><a href="https://docs.octoprint.org/en/1.4.1rc4/plugins/python3_migration.html">1.4.1rc4</a></dd>
    </dl>
    <dl>
      <dt>Branches</dt>
      <dd><a href="https://docs.octoprint.org/en/master/plugins/python3_migration.html">master</a></dd>
      <dd><a href="https://docs.octoprint.org/en/maintenance/plugins/python3_migration.html">maintenance</a></dd>
      <dd><a href="https://docs.octoprint.org/en/devel/plugins/python3_migration.html">devel</a></dd>
    </dl>
  </div>
</div>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>