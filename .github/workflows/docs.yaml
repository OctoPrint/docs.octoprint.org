name: Build & publish docs

on:
  repository_dispatch:
    types: [build_docs]

jobs:
  build-docs:
    name: Publish to Github Pages
    runs-on: ubuntu-latest
    steps:
      - name: ⬇ Checkout docs.octoprint.org
        uses: actions/checkout@v2
        with:
          path: docs.octoprint.org

      - name: ✔ Ensure we are active for the committish
        id: valid
        continue-on-error: true
        run: |
          grep "${{ github.event.client_payload.committish }}" ${{ github.workspace }}/docs.octoprint.org/.github/versionselector/versions.json

      - name: 👀 Determine latest OctoPrint release
        id: latest
        uses: pozetroninc/github-action-get-latest-release@master
        with:
          repository: "OctoPrint/OctoPrint"

      - name: ⬇ Checkout OctoPrint
        if: steps.valid.outcome == 'success'
        uses: actions/checkout@v2
        with:
          repository: "OctoPrint/OctoPrint"
          ref: ${{ github.event.client_payload.committish }}
          path: OctoPrint

      - name: 🐍 Set up Python ${{ github.event.client_payload.python }}
        if: steps.valid.outcome == 'success'
        uses: actions/setup-python@v2
        with:
          python-version: ${{ github.event.client_payload.python }}

      - name: 🏗 Install OctoPrint
        if: steps.valid.outcome == 'success'
        run: |
          cd ${{ github.workspace }}/OctoPrint
          pip install .[develop,docs]

      - name: 🏗 Build docs
        if: steps.valid.outcome == 'success'
        run: |
          cd ${{ github.workspace }}/docs.octoprint.org/.github/versionselector
          python versionselector.py ${{ github.workspace }}/OctoPrint/docs/ ${{ github.event.client_payload.committish }} ${{ steps.latest.outputs.release }} versions.json

      - name: ⬆ Copy build result
        if: steps.valid.outcome == 'success'
        run: |
          rm -rf ${{ github.workspace }}/docs.octoprint.org/${{ github.event.client_payload.committish }} || true
          cp -r ${{ github.workspace }}/OctoPrint/docs/_build/html/${{ github.event.client_payload.committish }} ${{ github.workspace }}/docs.octoprint.org/

      - name: 🚀 Deploy build
        uses: EndBug/add-and-commit@v4
        with:
          cwd: "${{ github.workspace }}/docs.octoprint.org"
          add: "${{ github.event.client_payload.committish }}"
          message: "Publish new build of docs for ${{ github.event.client_payload.committish }}"
          author_name: 'github-actions[bot]'
          author_email: 'github-actions[bot]@users.noreply.github.com'
