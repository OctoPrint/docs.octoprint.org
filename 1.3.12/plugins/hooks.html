

<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Hooks &mdash; OctoPrint 1.3.12 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../',
              VERSION:'1.3.12',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="https://unpkg.com/mermaid@8.4.8/dist/mermaid.min.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Helpers" href="helpers.html" />
    <link rel="prev" title="Mixins" href="mixins.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> OctoPrint
          

          
          </a>

          
            
            
              <div class="version">
                1.3.12
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../features/index.html">Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bundledplugins/index.html">Bundled Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../configuration/index.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/index.html">REST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../events/index.html">Events</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development/index.html">Development</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Developing Plugins</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="concepts.html">General Concepts</a></li>
<li class="toctree-l2"><a class="reference internal" href="controlproperties.html">Control Properties</a></li>
<li class="toctree-l2"><a class="reference internal" href="mixins.html">Mixins</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Hooks</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#general-concepts">General Concepts</a></li>
<li class="toctree-l3"><a class="reference internal" href="#execution-order">Execution Order</a></li>
<li class="toctree-l3"><a class="reference internal" href="#available-plugin-hooks">Available plugin hooks</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#octoprint-accesscontrol-appkey">octoprint.accesscontrol.appkey</a></li>
<li class="toctree-l4"><a class="reference internal" href="#octoprint-accesscontrol-keyvalidator">octoprint.accesscontrol.keyvalidator</a></li>
<li class="toctree-l4"><a class="reference internal" href="#octoprint-cli-commands">octoprint.cli.commands</a></li>
<li class="toctree-l4"><a class="reference internal" href="#octoprint-comm-protocol-firmware-info">octoprint.comm.protocol.firmware.info</a></li>
<li class="toctree-l4"><a class="reference internal" href="#octoprint-comm-firmware-protocol-capabilities">octoprint.comm.firmware.protocol.capabilities</a></li>
<li class="toctree-l4"><a class="reference internal" href="#octoprint-comm-protocol-action">octoprint.comm.protocol.action</a></li>
<li class="toctree-l4"><a class="reference internal" href="#octoprint-comm-protocol-atcommand-phase">octoprint.comm.protocol.atcommand.&lt;phase&gt;</a></li>
<li class="toctree-l4"><a class="reference internal" href="#octoprint-comm-protocol-gcode-phase">octoprint.comm.protocol.gcode.&lt;phase&gt;</a></li>
<li class="toctree-l4"><a class="reference internal" href="#octoprint-comm-protocol-gcode-received">octoprint.comm.protocol.gcode.received</a></li>
<li class="toctree-l4"><a class="reference internal" href="#octoprint-comm-protocol-gcode-error">octoprint.comm.protocol.gcode.error</a></li>
<li class="toctree-l4"><a class="reference internal" href="#octoprint-comm-protocol-scripts">octoprint.comm.protocol.scripts</a></li>
<li class="toctree-l4"><a class="reference internal" href="#octoprint-comm-protocol-temperatures-received">octoprint.comm.protocol.temperatures.received</a></li>
<li class="toctree-l4"><a class="reference internal" href="#octoprint-comm-transport-serial-factory">octoprint.comm.transport.serial.factory</a></li>
<li class="toctree-l4"><a class="reference internal" href="#octoprint-events-register-custom-events">octoprint.events.register_custom_events</a></li>
<li class="toctree-l4"><a class="reference internal" href="#octoprint-filemanager-analysis-factory">octoprint.filemanager.analysis.factory</a></li>
<li class="toctree-l4"><a class="reference internal" href="#octoprint-filemanager-extension-tree">octoprint.filemanager.extension_tree</a></li>
<li class="toctree-l4"><a class="reference internal" href="#octoprint-filemanager-preprocessor">octoprint.filemanager.preprocessor</a></li>
<li class="toctree-l4"><a class="reference internal" href="#octoprint-printer-factory">octoprint.printer.factory</a></li>
<li class="toctree-l4"><a class="reference internal" href="#octoprint-printer-estimation-factory">octoprint.printer.estimation.factory</a></li>
<li class="toctree-l4"><a class="reference internal" href="#octoprint-printer-sdcardupload">octoprint.printer.sdcardupload</a></li>
<li class="toctree-l4"><a class="reference internal" href="#octoprint-server-api-after-request">octoprint.server.api.after_request</a></li>
<li class="toctree-l4"><a class="reference internal" href="#octoprint-server-api-before-request">octoprint.server.api.before_request</a></li>
<li class="toctree-l4"><a class="reference internal" href="#octoprint-server-http-access-validator">octoprint.server.http.access_validator</a></li>
<li class="toctree-l4"><a class="reference internal" href="#octoprint-server-http-bodysize">octoprint.server.http.bodysize</a></li>
<li class="toctree-l4"><a class="reference internal" href="#octoprint-server-http-routes">octoprint.server.http.routes</a></li>
<li class="toctree-l4"><a class="reference internal" href="#octoprint-server-sockjs-authed">octoprint.server.sockjs.authed</a></li>
<li class="toctree-l4"><a class="reference internal" href="#octoprint-server-sockjs-register">octoprint.server.sockjs.register</a></li>
<li class="toctree-l4"><a class="reference internal" href="#octoprint-server-sockjs-emit">octoprint.server.sockjs.emit</a></li>
<li class="toctree-l4"><a class="reference internal" href="#octoprint-timelapse-extensions">octoprint.timelapse.extensions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#octoprint-ui-web-templatetypes">octoprint.ui.web.templatetypes</a></li>
<li class="toctree-l4"><a class="reference internal" href="#octoprint-users-factory">octoprint.users.factory</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="helpers.html">Helpers</a></li>
<li class="toctree-l2"><a class="reference internal" href="injectedproperties.html">Injected Properties</a></li>
<li class="toctree-l2"><a class="reference internal" href="viewmodels.html">Viewmodels</a></li>
<li class="toctree-l2"><a class="reference internal" href="gettingstarted.html">Plugin Tutorial</a></li>
<li class="toctree-l2"><a class="reference internal" href="distributing.html">Distributing your plugin</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../modules/index.html">Internal Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../jsclientlib/index.html">JavaScript Client Library</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">OctoPrint</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">


  <p style="padding: 10px;margin: 0 0 10px 0;border-radius: 2px;letter-spacing: 1px;font-size: 13px;color: white;text-align: center;background: #3a87ad;background-image: none;background-size: auto;background-size: 28px 28px;background-image: linear-gradient( -45deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.2) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, 0.2) 50%, rgba(255, 255, 255, 0.2) 75%, transparent 75%, transparent );">
    <strong>Note:</strong>
    These are not the docs of the latest released version. Those can be found <a href="https://docs.octoprint.org/en/1.4.2" style="color: white;text-decoration: underline">here</a>.
  </p>


  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Developing Plugins</a> &raquo;</li>
        
      <li>Hooks</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/plugins/hooks.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="hooks">
<span id="sec-plugins-hooks"></span><h1>Hooks<a class="headerlink" href="#hooks" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#general-concepts" id="id24">General Concepts</a></li>
<li><a class="reference internal" href="#execution-order" id="id25">Execution Order</a></li>
<li><a class="reference internal" href="#available-plugin-hooks" id="id26">Available plugin hooks</a><ul>
<li><a class="reference internal" href="#octoprint-accesscontrol-appkey" id="id27">octoprint.accesscontrol.appkey</a></li>
<li><a class="reference internal" href="#octoprint-accesscontrol-keyvalidator" id="id28">octoprint.accesscontrol.keyvalidator</a></li>
<li><a class="reference internal" href="#octoprint-cli-commands" id="id29">octoprint.cli.commands</a></li>
<li><a class="reference internal" href="#octoprint-comm-protocol-firmware-info" id="id30">octoprint.comm.protocol.firmware.info</a></li>
<li><a class="reference internal" href="#octoprint-comm-firmware-protocol-capabilities" id="id31">octoprint.comm.firmware.protocol.capabilities</a></li>
<li><a class="reference internal" href="#octoprint-comm-protocol-action" id="id32">octoprint.comm.protocol.action</a></li>
<li><a class="reference internal" href="#octoprint-comm-protocol-atcommand-phase" id="id33">octoprint.comm.protocol.atcommand.&lt;phase&gt;</a></li>
<li><a class="reference internal" href="#octoprint-comm-protocol-gcode-phase" id="id34">octoprint.comm.protocol.gcode.&lt;phase&gt;</a></li>
<li><a class="reference internal" href="#octoprint-comm-protocol-gcode-received" id="id35">octoprint.comm.protocol.gcode.received</a></li>
<li><a class="reference internal" href="#octoprint-comm-protocol-gcode-error" id="id36">octoprint.comm.protocol.gcode.error</a></li>
<li><a class="reference internal" href="#octoprint-comm-protocol-scripts" id="id37">octoprint.comm.protocol.scripts</a></li>
<li><a class="reference internal" href="#octoprint-comm-protocol-temperatures-received" id="id38">octoprint.comm.protocol.temperatures.received</a></li>
<li><a class="reference internal" href="#octoprint-comm-transport-serial-factory" id="id39">octoprint.comm.transport.serial.factory</a></li>
<li><a class="reference internal" href="#octoprint-events-register-custom-events" id="id40">octoprint.events.register_custom_events</a></li>
<li><a class="reference internal" href="#octoprint-filemanager-analysis-factory" id="id41">octoprint.filemanager.analysis.factory</a></li>
<li><a class="reference internal" href="#octoprint-filemanager-extension-tree" id="id42">octoprint.filemanager.extension_tree</a></li>
<li><a class="reference internal" href="#octoprint-filemanager-preprocessor" id="id43">octoprint.filemanager.preprocessor</a></li>
<li><a class="reference internal" href="#octoprint-printer-factory" id="id44">octoprint.printer.factory</a></li>
<li><a class="reference internal" href="#octoprint-printer-estimation-factory" id="id45">octoprint.printer.estimation.factory</a></li>
<li><a class="reference internal" href="#octoprint-printer-sdcardupload" id="id46">octoprint.printer.sdcardupload</a></li>
<li><a class="reference internal" href="#octoprint-server-api-after-request" id="id47">octoprint.server.api.after_request</a></li>
<li><a class="reference internal" href="#octoprint-server-api-before-request" id="id48">octoprint.server.api.before_request</a></li>
<li><a class="reference internal" href="#octoprint-server-http-access-validator" id="id49">octoprint.server.http.access_validator</a></li>
<li><a class="reference internal" href="#octoprint-server-http-bodysize" id="id50">octoprint.server.http.bodysize</a></li>
<li><a class="reference internal" href="#octoprint-server-http-routes" id="id51">octoprint.server.http.routes</a></li>
<li><a class="reference internal" href="#octoprint-server-sockjs-authed" id="id52">octoprint.server.sockjs.authed</a></li>
<li><a class="reference internal" href="#octoprint-server-sockjs-register" id="id53">octoprint.server.sockjs.register</a></li>
<li><a class="reference internal" href="#octoprint-server-sockjs-emit" id="id54">octoprint.server.sockjs.emit</a></li>
<li><a class="reference internal" href="#octoprint-timelapse-extensions" id="id55">octoprint.timelapse.extensions</a></li>
<li><a class="reference internal" href="#octoprint-ui-web-templatetypes" id="id56">octoprint.ui.web.templatetypes</a></li>
<li><a class="reference internal" href="#octoprint-users-factory" id="id57">octoprint.users.factory</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="general-concepts">
<span id="sec-plugins-hooks-general"></span><h2><a class="toc-backref" href="#id24">General Concepts</a><a class="headerlink" href="#general-concepts" title="Permalink to this headline">¶</a></h2>
<p>Hooks are the smaller siblings of <a class="reference internal" href="mixins.html#sec-plugins-mixins"><span class="std std-ref">mixins</span></a>, allowing to extend functionality or data processing where a custom mixin type
would be too much overhead. Where mixins are based on classes, hooks are based on methods. Like with the mixin
implementations, plugins inform OctoPrint about hook handlers using a control property, <code class="docutils literal"><span class="pre">__plugin_hooks__</span></code>.</p>
<p>This control property is a dictionary consisting of the implemented hooks’ names as keys and either the hook callback
or a 2-tuple of hook callback and order value as value.</p>
<p>Each hook defines a contract detailing the call parameters for the hook handler method and the expected return type.
OctoPrint will call the hook with the define parameters and process the result depending on the hook.</p>
<p>An example for a hook within OctoPrint is <code class="docutils literal"><span class="pre">octoprint.comm.protocol.scripts</span></code>, which allows adding additional
lines to OctoPrint’s <a class="reference internal" href="../features/gcode_scripts.html#sec-features-gcode-scripts"><span class="std std-ref">GCODE scripts</span></a>, either as <code class="docutils literal"><span class="pre">prefix</span></code> (before the existing lines)
or as <code class="docutils literal"><span class="pre">postfix</span></code> (after the existing lines).</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">_gcode_hooks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pluginManager</span><span class="o">.</span><span class="n">get_hooks</span><span class="p">(</span><span class="s2">&quot;octoprint.comm.protocol.scripts&quot;</span><span class="p">)</span>

<span class="c1"># ...</span>

<span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gcodescript_hooks</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gcodescript_hooks</span><span class="p">[</span><span class="n">hook</span><span class="p">](</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;gcode&quot;</span><span class="p">,</span> <span class="n">scriptName</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Error while processing gcodescript hook </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">hook</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">retval</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">def</span> <span class="nf">to_list</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">strip</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">unicode</span><span class="p">):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">unicode</span><span class="o">.</span><span class="n">strip</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">))</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

        <span class="n">prefix</span><span class="p">,</span> <span class="n">suffix</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">to_list</span><span class="p">,</span> <span class="n">retval</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">prefix</span><span class="p">:</span>
            <span class="n">scriptLines</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="o">+</span> <span class="n">scriptLines</span>
        <span class="k">if</span> <span class="n">suffix</span><span class="p">:</span>
            <span class="n">scriptLines</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>As you can see, the hook’s method signature is defined to take the current <code class="docutils literal"><span class="pre">self</span></code> (as in, the current comm layer instance),
the general type of script for which to look for additions (“gcode”) and the script name for which to look (e.g.
<code class="docutils literal"><span class="pre">beforePrintStarted</span></code> for the GCODE script executed before the beginning of a print job). The hook is expected to
return a 2-tuple of prefix and postfix if has something for either of those, otherwise <code class="docutils literal"><span class="pre">None</span></code>. OctoPrint will then take
care to add prefix and suffix as necessary after a small round of preprocessing.</p>
<p>Plugins can easily add their own hooks too. For example, the <a class="reference external" href="https://github.com/foosel/OctoPrint/tree/master/src/octoprint/plugins/softwareupdate">Software Update Plugin</a>
declares a custom hook “octoprint.plugin.softwareupdate.check_config” which other plugins can add handlers for in order
to register themselves with the Software Update Plugin by returning their own update check configuration.</p>
<p>If you want your hook handler to be an instance method of a mixin implementation of your plugin (for example since you
need access to instance variables handed to your implementation via mixin invocations), you can get this work
by using a small trick. Instead of defining it directly via <code class="docutils literal"><span class="pre">__plugin_hooks__</span></code> utilize the <code class="docutils literal"><span class="pre">__plugin_load__</span></code>
property instead, manually instantiate your implementation instance and then add its hook handler method to the
<code class="docutils literal"><span class="pre">__plugin_hooks__</span></code> property and itself to the <code class="docutils literal"><span class="pre">__plugin_implementation__</span></code> property. See the following example.</p>
<div class="literal-block-wrapper docutils container" id="sec-plugin-concepts-hooks-example">
<div class="code-block-caption"><span class="caption-number">Listing 12 </span><span class="caption-text"><a class="reference external" href="https://github.com/OctoPrint/Plugin-Examples/blob/master/custom_action_command.py">custom_action_command.py</a></span><a class="headerlink" href="#sec-plugin-concepts-hooks-example" title="Permalink to this code">¶</a></div>
<div class="highlight-default"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># coding=utf-8</span>

<span class="kn">import</span> <span class="nn">octoprint.plugin</span>

<span class="k">class</span> <span class="nc">CustomActionCommandPlugin</span><span class="p">(</span><span class="n">octoprint</span><span class="o">.</span><span class="n">plugin</span><span class="o">.</span><span class="n">OctoPrintPlugin</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">custom_action_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comm</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;custom&quot;</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Received </span><span class="se">\&quot;</span><span class="s2">custom</span><span class="se">\&quot;</span><span class="s2"> action from printer&quot;</span><span class="p">)</span>

<span class="n">__plugin_name__</span> <span class="o">=</span> <span class="s2">&quot;Custom action command&quot;</span>
<span class="n">__plugin_pythoncompat__</span> <span class="o">=</span> <span class="s2">&quot;&gt;=2.7,&lt;4&quot;</span>

<span class="k">def</span> <span class="nf">__plugin_load__</span><span class="p">():</span>
    <span class="n">plugin</span> <span class="o">=</span> <span class="n">CustomActionCommandPlugin</span><span class="p">()</span>

    <span class="k">global</span> <span class="n">__plugin_implementation__</span>
    <span class="n">__plugin_implementation__</span> <span class="o">=</span> <span class="n">plugin</span>

    <span class="k">global</span> <span class="n">__plugin_hooks__</span>
    <span class="n">__plugin_hooks__</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;octoprint.comm.protocol.action&quot;</span><span class="p">:</span> <span class="n">plugin</span><span class="o">.</span><span class="n">custom_action_handler</span><span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="execution-order">
<span id="sec-plugins-hooks-ordering"></span><h2><a class="toc-backref" href="#id25">Execution Order</a><a class="headerlink" href="#execution-order" title="Permalink to this headline">¶</a></h2>
<p>Hooks may also define an order number to allow influencing the execution order of the registered hook handlers. Instead
of registering only a callback as hook handler, it is also possible to register a 2-tuple consisting of a callback and
an integer value used for ordering handlers. They way this works is that OctoPrint will first sort all registered
hook handlers with a order number, taking their identifier as the second sorting criteria, then after that append
all hook handlers without a order number sorted only by their identifier.</p>
<p>An example should help clear this up. Let’s assume we have the following plugin <code class="docutils literal"><span class="pre">ordertest</span></code> which defines a new
hook called <code class="docutils literal"><span class="pre">octoprint.plugin.ordertest.callback</span></code>:</p>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-number">Listing 13 </span><span class="caption-text">ordertest.py</span><a class="headerlink" href="#id3" title="Permalink to this code">¶</a></div>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">octoprint.plugin</span>

<span class="k">class</span> <span class="nc">OrderTestPlugin</span><span class="p">(</span><span class="n">octoprint</span><span class="o">.</span><span class="n">plugin</span><span class="o">.</span><span class="n">StartupPlugin</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get_sorting_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sorting_context</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">10</span>

    <span class="k">def</span> <span class="nf">on_startup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;############### Order Test Plugin: StartupPlugin.on_startup called&quot;</span><span class="p">)</span>
        <span class="n">hooks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plugin_manager</span><span class="o">.</span><span class="n">get_hooks</span><span class="p">(</span><span class="s2">&quot;octoprint.plugin.ordertest.callback&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">hook</span> <span class="ow">in</span> <span class="n">hooks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">hook</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">on_after_startup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;############### Order Test Plugin: StartupPlugin.on_after_startup called&quot;</span><span class="p">)</span>

<span class="n">__plugin_name__</span> <span class="o">=</span> <span class="s2">&quot;Order Test&quot;</span>
<span class="n">__plugin_version__</span> <span class="o">=</span> <span class="s2">&quot;0.1.0&quot;</span>
<span class="n">__plugin_implementation__</span> <span class="o">=</span> <span class="n">OrderTestPlugin</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
</div>
<p>And these three plugins defining handlers for that hook:</p>
<div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-number">Listing 14 </span><span class="caption-text">oneorderedhook.py</span><a class="headerlink" href="#id4" title="Permalink to this code">¶</a></div>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">logging</span>

 <span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
     <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;octoprint.plugins.&quot;</span> <span class="o">+</span> <span class="vm">__name__</span><span class="p">)</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Callback called in oneorderedhook&quot;</span><span class="p">)</span>

 <span class="n">__plugin_name__</span> <span class="o">=</span> <span class="s2">&quot;One Ordered Hook&quot;</span>
 <span class="n">__plugin_version__</span> <span class="o">=</span> <span class="s2">&quot;0.1.0&quot;</span>
 <span class="n">__plugin_hooks__</span> <span class="o">=</span> <span class="p">{</span>
     <span class="s2">&quot;octoprint.plugin.ordertest.callback&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
 <span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="literal-block-wrapper docutils container" id="id5">
<div class="code-block-caption"><span class="caption-number">Listing 15 </span><span class="caption-text">anotherorderedhook.py</span><a class="headerlink" href="#id5" title="Permalink to this code">¶</a></div>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">logging</span>

<span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;octoprint.plugins.&quot;</span> <span class="o">+</span> <span class="vm">__name__</span><span class="p">)</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Callback called in anotherorderedhook&quot;</span><span class="p">)</span>

<span class="n">__plugin_name__</span> <span class="o">=</span> <span class="s2">&quot;Another Ordered Hook&quot;</span>
<span class="n">__plugin_version__</span> <span class="o">=</span> <span class="s2">&quot;0.1.0&quot;</span>
<span class="n">__plugin_hooks__</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;octoprint.plugin.ordertest.callback&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="literal-block-wrapper docutils container" id="id6">
<div class="code-block-caption"><span class="caption-number">Listing 16 </span><span class="caption-text">yetanotherhook.py</span><a class="headerlink" href="#id6" title="Permalink to this code">¶</a></div>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">logging</span>

<span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;octoprint.plugins.&quot;</span> <span class="o">+</span> <span class="vm">__name__</span><span class="p">)</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Callback called in yetanotherhook&quot;</span><span class="p">)</span>

<span class="n">__plugin_name__</span> <span class="o">=</span> <span class="s2">&quot;Yet Another Hook&quot;</span>
<span class="n">__plugin_version__</span> <span class="o">=</span> <span class="s2">&quot;0.1.0&quot;</span>
<span class="n">__plugin_hooks__</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;octoprint.plugin.ordertest.callback&quot;</span><span class="p">:</span> <span class="n">callback</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<p>Both <code class="docutils literal"><span class="pre">orderedhook.py</span></code> and <code class="docutils literal"><span class="pre">anotherorderedhook.py</span></code> not only define a handler callback in the hook registration,
but actually a 2-tuple consisting of a callback and an order number. <code class="docutils literal"><span class="pre">yetanotherhook.py</span></code> only defines a callback.</p>
<p>OctoPrint will sort these hooks so that <code class="docutils literal"><span class="pre">orderedhook</span></code> will be called first, then <code class="docutils literal"><span class="pre">anotherorderedhook</span></code>, then
<code class="docutils literal"><span class="pre">yetanotherhook</span></code>. Just going by the identifiers, the expected order would be <code class="docutils literal"><span class="pre">anotherorderedhook</span></code>, <code class="docutils literal"><span class="pre">orderedhook</span></code>,
<code class="docutils literal"><span class="pre">yetanotherhook</span></code>, but since <code class="docutils literal"><span class="pre">orderedhook</span></code> defines a lower order number (<code class="docutils literal"><span class="pre">1</span></code>) than <code class="docutils literal"><span class="pre">anotherorderedhook</span></code> (<code class="docutils literal"><span class="pre">2</span></code>),
it will be sorted before <code class="docutils literal"><span class="pre">anotherorderedhook</span></code>. If you copy those files into your <code class="docutils literal"><span class="pre">~/.octoprint/plugins</span></code> folder
and start up OctoPrint, you’ll see output like this:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>[...]
2016-03-24 09:29:21,342 - octoprint.plugins.ordertest - INFO - ############### Order Test Plugin: StartupPlugin.on_startup called
2016-03-24 09:29:21,355 - octoprint.plugins.oneorderedhook - INFO - Callback called in oneorderedhook
2016-03-24 09:29:21,357 - octoprint.plugins.anotherorderedhook - INFO - Callback called in anotherorderedhook
2016-03-24 09:29:21,358 - octoprint.plugins.yetanotherhook - INFO - Callback called in yetanotherhook
[...]
2016-03-24 09:29:21,861 - octoprint.plugins.ordertest - INFO - ############### Order Test Plugin: StartupPlugin.on_after_startup called
[...]
</pre></div>
</div>
</div>
<div class="section" id="available-plugin-hooks">
<span id="sec-plugins-hooks-available"></span><h2><a class="toc-backref" href="#id26">Available plugin hooks</a><a class="headerlink" href="#available-plugin-hooks" title="Permalink to this headline">¶</a></h2>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">All of the hooks below take at least two parameters, <code class="docutils literal"><span class="pre">*args</span></code> and <code class="docutils literal"><span class="pre">**kwargs</span></code>. Make sure those are
<strong>always</strong> present in your hook handler declaration.
They will act as placeholders if additional parameters are added to the hooks in the future and will allow
your plugin to stay compatible to OctoPrint without any necessary adjustments from you in these cases.</p>
</div>
<div class="contents local topic" id="id1">
<ul class="simple">
<li><a class="reference internal" href="#octoprint-accesscontrol-appkey" id="id58">octoprint.accesscontrol.appkey</a></li>
<li><a class="reference internal" href="#octoprint-accesscontrol-keyvalidator" id="id59">octoprint.accesscontrol.keyvalidator</a></li>
<li><a class="reference internal" href="#octoprint-cli-commands" id="id60">octoprint.cli.commands</a></li>
<li><a class="reference internal" href="#octoprint-comm-protocol-firmware-info" id="id61">octoprint.comm.protocol.firmware.info</a></li>
<li><a class="reference internal" href="#octoprint-comm-firmware-protocol-capabilities" id="id62">octoprint.comm.firmware.protocol.capabilities</a></li>
<li><a class="reference internal" href="#octoprint-comm-protocol-action" id="id63">octoprint.comm.protocol.action</a></li>
<li><a class="reference internal" href="#octoprint-comm-protocol-atcommand-phase" id="id64">octoprint.comm.protocol.atcommand.&lt;phase&gt;</a></li>
<li><a class="reference internal" href="#octoprint-comm-protocol-gcode-phase" id="id65">octoprint.comm.protocol.gcode.&lt;phase&gt;</a></li>
<li><a class="reference internal" href="#octoprint-comm-protocol-gcode-received" id="id66">octoprint.comm.protocol.gcode.received</a></li>
<li><a class="reference internal" href="#octoprint-comm-protocol-gcode-error" id="id67">octoprint.comm.protocol.gcode.error</a></li>
<li><a class="reference internal" href="#octoprint-comm-protocol-scripts" id="id68">octoprint.comm.protocol.scripts</a></li>
<li><a class="reference internal" href="#octoprint-comm-protocol-temperatures-received" id="id69">octoprint.comm.protocol.temperatures.received</a></li>
<li><a class="reference internal" href="#octoprint-comm-transport-serial-factory" id="id70">octoprint.comm.transport.serial.factory</a></li>
<li><a class="reference internal" href="#octoprint-events-register-custom-events" id="id71">octoprint.events.register_custom_events</a></li>
<li><a class="reference internal" href="#octoprint-filemanager-analysis-factory" id="id72">octoprint.filemanager.analysis.factory</a></li>
<li><a class="reference internal" href="#octoprint-filemanager-extension-tree" id="id73">octoprint.filemanager.extension_tree</a></li>
<li><a class="reference internal" href="#octoprint-filemanager-preprocessor" id="id74">octoprint.filemanager.preprocessor</a></li>
<li><a class="reference internal" href="#octoprint-printer-factory" id="id75">octoprint.printer.factory</a></li>
<li><a class="reference internal" href="#octoprint-printer-estimation-factory" id="id76">octoprint.printer.estimation.factory</a></li>
<li><a class="reference internal" href="#octoprint-printer-sdcardupload" id="id77">octoprint.printer.sdcardupload</a></li>
<li><a class="reference internal" href="#octoprint-server-api-after-request" id="id78">octoprint.server.api.after_request</a></li>
<li><a class="reference internal" href="#octoprint-server-api-before-request" id="id79">octoprint.server.api.before_request</a></li>
<li><a class="reference internal" href="#octoprint-server-http-access-validator" id="id80">octoprint.server.http.access_validator</a></li>
<li><a class="reference internal" href="#octoprint-server-http-bodysize" id="id81">octoprint.server.http.bodysize</a></li>
<li><a class="reference internal" href="#octoprint-server-http-routes" id="id82">octoprint.server.http.routes</a></li>
<li><a class="reference internal" href="#octoprint-server-sockjs-authed" id="id83">octoprint.server.sockjs.authed</a></li>
<li><a class="reference internal" href="#octoprint-server-sockjs-register" id="id84">octoprint.server.sockjs.register</a></li>
<li><a class="reference internal" href="#octoprint-server-sockjs-emit" id="id85">octoprint.server.sockjs.emit</a></li>
<li><a class="reference internal" href="#octoprint-timelapse-extensions" id="id86">octoprint.timelapse.extensions</a></li>
<li><a class="reference internal" href="#octoprint-ui-web-templatetypes" id="id87">octoprint.ui.web.templatetypes</a></li>
<li><a class="reference internal" href="#octoprint-users-factory" id="id88">octoprint.users.factory</a></li>
</ul>
</div>
<div class="section" id="octoprint-accesscontrol-appkey">
<span id="sec-plugins-hook-accesscontrol-appkey"></span><h3><a class="toc-backref" href="#id58">octoprint.accesscontrol.appkey</a><a class="headerlink" href="#octoprint-accesscontrol-appkey" title="Permalink to this headline">¶</a></h3>
<dl class="function">
<dt id="acl_appkey_hook">
<code class="descname">acl_appkey_hook</code><span class="sig-paren">(</span><em>*args</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#acl_appkey_hook" title="Permalink to this definition">¶</a></dt>
<dd><div class="deprecated">
<p><span class="versionmodified">Deprecated since version 1.3.11: </span>This functionality will be removed in 1.4.0. Use the <a class="reference internal" href="../bundledplugins/appkeys.html#sec-bundledplugins-appkeys-workflow"><span class="std std-ref">Application Keys Plugin workflow</span></a> instead.</p>
</div>
<p>By handling this hook plugins may register additional <a class="reference internal" href="../api/apps.html#sec-api-apps-sessionkey"><span class="std std-ref">App session key providers</span></a>
within the system.</p>
<p>Overrides this to return your additional app information to be used for validating app session keys. You’ll
need to return a list of 3-tuples of the format (id, version, public key).</p>
<p>The <code class="docutils literal"><span class="pre">id</span></code> should be the (unique) identifier of the app. Using a domain prefix might make sense here, e.g.
<code class="docutils literal"><span class="pre">org.octoprint.example.MyApp</span></code>.</p>
<p><code class="docutils literal"><span class="pre">version</span></code> should be a string specifying the version of the app for which the public key is valid. You can
provide the string <code class="docutils literal"><span class="pre">any</span></code> here, in which case the provided public key will be valid for all versions of the
app for which no specific public key is defined.</p>
<p>Finally, the public key is expected to be provided as a PKCS1 string without newlines.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body">A list of 3-tuples as described above</td>
</tr>
<tr class="field-even field"><th class="field-name">Return type:</th><td class="field-body">list</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
<div class="section" id="octoprint-accesscontrol-keyvalidator">
<span id="sec-plugins-hook-accesscontrol-keyvalidator"></span><h3><a class="toc-backref" href="#id59">octoprint.accesscontrol.keyvalidator</a><a class="headerlink" href="#octoprint-accesscontrol-keyvalidator" title="Permalink to this headline">¶</a></h3>
<dl class="function">
<dt id="acl_keyvalidator_hook">
<code class="descname">acl_keyvalidator_hook</code><span class="sig-paren">(</span><em>apikey</em>, <em>*args</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#acl_keyvalidator_hook" title="Permalink to this definition">¶</a></dt>
<dd><p>Via this hook plugins may validate their own customized API keys to be used to access OctoPrint’s API.</p>
<p><code class="docutils literal"><span class="pre">apikey</span></code> will be the API key as read from the request headers.</p>
<p>Hook handlers are expected to return a <code class="xref py py-class docutils literal"><span class="pre">User</span></code> instance here that will then be considered that
user making the request. By returning <code class="docutils literal"><span class="pre">None</span></code> or nothing at all, hook handlers signal that they do not handle the
provided key.</p>
<p><strong>Example:</strong></p>
<p>Allows using a user’s id as their API key (for obvious reasons this is NOT recommended in production environments
and merely provided for educational purposes):</p>
<div class="literal-block-wrapper docutils container" id="id7">
<div class="code-block-caption"><span class="caption-number">Listing 17 </span><span class="caption-text"><a class="reference external" href="https://github.com/OctoPrint/Plugin-Examples/blob/master/custom_keyvalidator.py">custom_keyvalidator.py</a></span><a class="headerlink" href="#id7" title="Permalink to this code">¶</a></div>
<div class="highlight-default"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># Needs OctoPrint 1.3.6 or newer</span>

<span class="k">def</span> <span class="nf">hook</span><span class="p">(</span><span class="n">apikey</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">octoprint.server</span> <span class="kn">import</span> <span class="n">userManager</span>
    <span class="k">return</span> <span class="n">userManager</span><span class="o">.</span><span class="n">findUser</span><span class="p">(</span><span class="n">userid</span><span class="o">=</span><span class="n">apikey</span><span class="p">)</span>

<span class="n">__plugin_pythoncompat__</span> <span class="o">=</span> <span class="s2">&quot;&gt;=2.7,&lt;4&quot;</span>
<span class="n">__plugin_hooks__</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;octoprint.accesscontrol.keyvalidator&quot;</span><span class="p">:</span> <span class="n">hook</span>
<span class="p">}</span>

</pre></div>
</td></tr></table></div>
</div>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.3.6.</span></p>
</div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>apikey</strong> (<em>str</em>) – The API key to validate</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body">The user in whose name the request will be processed further</td>
</tr>
<tr class="field-odd field"><th class="field-name">Return type:</th><td class="field-body"><code class="xref py py-class docutils literal"><span class="pre">User</span></code></td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
<div class="section" id="octoprint-cli-commands">
<span id="sec-plugins-hook-cli-commands"></span><h3><a class="toc-backref" href="#id60">octoprint.cli.commands</a><a class="headerlink" href="#octoprint-cli-commands" title="Permalink to this headline">¶</a></h3>
<dl class="function">
<dt id="cli_commands_hook">
<code class="descname">cli_commands_hook</code><span class="sig-paren">(</span><em>cli_group</em>, <em>pass_octoprint_ctx</em>, <em>*args</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#cli_commands_hook" title="Permalink to this definition">¶</a></dt>
<dd><p>By providing a handler for this hook plugins may register commands on OctoPrint’s command line interface (CLI).</p>
<p>Handlers are expected to return a list of callables annotated as <a class="reference external" href="http://click.pocoo.org/5/">Click commands</a> to register with the
CLI.</p>
<p>The custom <code class="docutils literal"><span class="pre">MultiCommand</span></code> instance <a class="reference internal" href="../modules/cli.html#octoprint.cli.plugins.OctoPrintPluginCommands" title="octoprint.cli.plugins.OctoPrintPluginCommands"><code class="xref py py-class docutils literal"><span class="pre">OctoPrintPluginCommands</span></code></a> is provided
as parameter. Via that object handlers may access the <em>global</em> <a class="reference internal" href="../modules/settings.html#octoprint.settings.Settings" title="octoprint.settings.Settings"><code class="xref py py-class docutils literal"><span class="pre">Settings</span></code></a>
and the <a class="reference internal" href="../modules/plugin.html#octoprint.plugin.core.PluginManager" title="octoprint.plugin.core.PluginManager"><code class="xref py py-class docutils literal"><span class="pre">PluginManager</span></code></a> instance as <code class="docutils literal"><span class="pre">cli_group.settings</span></code> and <code class="docutils literal"><span class="pre">cli_group.plugin_manager</span></code>.</p>
<p><strong>Example:</strong></p>
<p>Registers two new commands, <code class="docutils literal"><span class="pre">custom_cli_command:greet</span></code> and <code class="docutils literal"><span class="pre">custom_cli_command:random</span></code> with
OctoPrint:</p>
<div class="literal-block-wrapper docutils container" id="id8">
<div class="code-block-caption"><span class="caption-number">Listing 18 </span><span class="caption-text"><a class="reference external" href="https://github.com/OctoPrint/Plugin-Examples/blob/master/custom_cli_command.py">custom_cli_command.py</a></span><a class="headerlink" href="#id8" title="Permalink to this code">¶</a></div>
<div class="highlight-default"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># Needs OctoPrint 1.3.x or newer</span>

<span class="kn">import</span> <span class="nn">click</span>

<span class="k">def</span> <span class="nf">clitest_commands</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="nd">@click</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s2">&quot;greet&quot;</span><span class="p">)</span>
    <span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--greeting&quot;</span><span class="p">,</span> <span class="s2">&quot;-g&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;Hello&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The greeting to use&quot;</span><span class="p">)</span>
    <span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;World&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">greet_command</span><span class="p">(</span><span class="n">greeting</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Greet someone by name, the greeting can be customized.&quot;&quot;&quot;</span>
        <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">greeting</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>


    <span class="nd">@click</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s2">&quot;random&quot;</span><span class="p">)</span>
    <span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;World&quot;</span><span class="p">)</span>
    <span class="nd">@click</span><span class="o">.</span><span class="n">pass_context</span>
    <span class="k">def</span> <span class="nf">random_greet_command</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Greet someone by name with a random greeting.&quot;&quot;&quot;</span>

        <span class="n">greetings</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;Hello&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Buon giorno&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Hola&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Konnichiwa&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Oh hai&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Hey&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Salve&quot;</span>
        <span class="p">]</span>

        <span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">randrange</span>
        <span class="n">greeting</span> <span class="o">=</span> <span class="n">greetings</span><span class="p">[</span><span class="n">randrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">greetings</span><span class="p">))]</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">greet_command</span><span class="p">,</span> <span class="n">greeting</span><span class="o">=</span><span class="n">greeting</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">greet_command</span><span class="p">,</span> <span class="n">random_greet_command</span><span class="p">]</span>

<span class="n">__plugin_pythoncompat__</span> <span class="o">=</span> <span class="s2">&quot;&gt;=2.7,&lt;4&quot;</span>
<span class="n">__plugin_hooks__</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;octoprint.cli.commands&quot;</span><span class="p">:</span> <span class="n">clitest_commands</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<p>Calling <code class="docutils literal"><span class="pre">octoprint</span> <span class="pre">plugins</span> <span class="pre">--help</span></code> shows the two new commands:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>$ octoprint plugins --help
Usage: octoprint plugins [OPTIONS] COMMAND [ARGS]...

  Additional commands provided by plugins.

Options:
  --help  Show this message and exit.

Commands:
  custom_cli_command:greet   Greet someone by name, the greeting can be...
  custom_cli_command:random  Greet someone by name with a random greeting.
  softwareupdate:check       Check for updates.
  softwareupdate:update      Apply updates.
</pre></div>
</div>
<p>Each also has an individual help output:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>$ octoprint plugins custom_cli_command:greet --help
Usage: octoprint plugins custom_cli_command:greet [OPTIONS] [NAME]

  Greet someone by name, the greeting can be customized.

Options:
  -g, --greeting TEXT  The greeting to use
  --help               Show this message and exit.

$ octoprint plugins custom_cli_command:random --help
Usage: octoprint plugins custom_cli_command:random [OPTIONS] [NAME]

  Greet someone by name with a random greeting.

Options:
  --help  Show this message and exit.
</pre></div>
</div>
<p>And of course they work too:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>$ octoprint plugins custom_cli_command:greet
Hello World!

$ octoprint plugins custom_cli_command:greet --greeting &quot;Good morning&quot;
Good morning World!

$ octoprint plugins custom_cli_command:random stranger
Hola stranger!
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>If your hook handler is an instance method of a plugin mixin implementation, be aware that the hook will be
called without OctoPrint initializing your implementation instance. That means that <strong>none</strong> of the
<a class="reference internal" href="mixins.html#sec-plugins-mixins-injectedproperties"><span class="std std-ref">injected properties</span></a> will be available and also the
<code class="xref py py-meth docutils literal"><span class="pre">initialize()</span></code> method will not be called.</p>
<p>Your hook handler will have access to the plugin manager as <code class="docutils literal"><span class="pre">cli_group.plugin_manager</span></code> and to the
<em>global</em> settings as <code class="docutils literal"><span class="pre">cli_group.settings</span></code>. You can have your handler turn the latter into a
<a class="reference internal" href="../modules/plugin.html#octoprint.plugin.PluginSettings" title="octoprint.plugin.PluginSettings"><code class="xref py py-class docutils literal"><span class="pre">PluginSettings</span></code></a> instance by using <code class="xref py py-func docutils literal"><span class="pre">octoprint.plugin.plugin_settings_from_settings_plugin()</span></code>
if your plugin’s implementation implements the <a class="reference internal" href="mixins.html#octoprint.plugin.SettingsPlugin" title="octoprint.plugin.SettingsPlugin"><code class="xref py py-class docutils literal"><span class="pre">SettingsPlugin</span></code></a> mixin and inject
that and the plugin manager instance yourself:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">octoprint.plugin</span>

<span class="k">class</span> <span class="nc">MyPlugin</span><span class="p">(</span><span class="n">octoprint</span><span class="o">.</span><span class="n">plugin</span><span class="o">.</span><span class="n">SettingsPlugin</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">get_cli_commands</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cli_group</span><span class="p">,</span> <span class="n">pass_octoprint_ctx</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">logging</span>

        <span class="n">settings</span> <span class="o">=</span> <span class="n">cli_group</span><span class="o">.</span><span class="n">_settings</span>
        <span class="n">plugin_settings</span> <span class="o">=</span> <span class="n">octoprint</span><span class="o">.</span><span class="n">plugin</span><span class="o">.</span><span class="n">plugin_settings_for_settings_plugin</span><span class="p">(</span><span class="s2">&quot;myplugin&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plugin_settings</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># this can happen if anything goes wrong with preparing the PluginSettings instance</span>
            <span class="k">return</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span> <span class="o">=</span> <span class="n">plugin_settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plugin_manager</span> <span class="o">=</span> <span class="n">cli_group</span><span class="o">.</span><span class="n">_plugin_manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

        <span class="c1">### command definition starts here</span>

        <span class="c1"># ...</span>
</pre></div>
</div>
<p class="last">No other platform components will be available - the CLI runs outside of a running, fully initialized
OctoPrint server context, so there is absolutely no way to access a printer connection, the event bus or
anything else like that. The only things available are the settings and the plugin manager.</p>
</div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body">A list of <a class="reference external" href="http://click.pocoo.org/5/commands/">Click commands or groups</a> to provide on
OctoPrint’s CLI.</td>
</tr>
<tr class="field-even field"><th class="field-name">Return type:</th><td class="field-body">list</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
<div class="section" id="octoprint-comm-protocol-firmware-info">
<span id="sec-plugins-hook-comm-protocol-firmware-info"></span><h3><a class="toc-backref" href="#id61">octoprint.comm.protocol.firmware.info</a><a class="headerlink" href="#octoprint-comm-protocol-firmware-info" title="Permalink to this headline">¶</a></h3>
<dl class="function">
<dt id="firmware_info_hook">
<code class="descname">firmware_info_hook</code><span class="sig-paren">(</span><em>comm_instance</em>, <em>firmware_name</em>, <em>firmware_data</em>, <em>*args</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#firmware_info_hook" title="Permalink to this definition">¶</a></dt>
<dd><p>Be notified of firmware information received from the printer following an <code class="docutils literal"><span class="pre">M115</span></code>.</p>
<p>Hook handlers may use this to react/adjust behaviour based on reported firmware data. OctoPrint parses the received
report line and provides the parsed <code class="docutils literal"><span class="pre">firmware_name</span></code> and additional <code class="docutils literal"><span class="pre">firmware_data</span></code> contained therein. A
response line <code class="docutils literal"><span class="pre">FIRMWARE_NAME:Some</span> <span class="pre">Firmware</span> <span class="pre">Name</span> <span class="pre">FIRMWARE_VERSION:1.2.3</span> <span class="pre">PROTOCOL_VERSION:1.0</span></code> for example will
be turned into a <code class="docutils literal"><span class="pre">dict</span></code> looking like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="nb">dict</span><span class="p">(</span><span class="n">FIRMWARE_NAME</span><span class="o">=</span><span class="s2">&quot;Some Firmware Name&quot;</span><span class="p">,</span>
     <span class="n">FIRMWARE_VERSION</span><span class="o">=</span><span class="s2">&quot;1.2.3&quot;</span><span class="p">,</span>
     <span class="n">PROTOCOL_VERSION</span><span class="o">=</span><span class="s2">&quot;1.0&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">firmware_name</span></code> will be <code class="docutils literal"><span class="pre">Some</span> <span class="pre">Firmware</span> <span class="pre">Name</span></code> in this case.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>Make sure to not perform any computationally expensive or otherwise long running actions within these handlers as
you will effectively block the receive loop, causing the communication with the printer to stall.</p>
<p class="last">This includes I/O of any kind.</p>
</div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>comm_instance</strong> (<em>object</em>) – The <code class="xref py py-class docutils literal"><span class="pre">MachineCom</span></code> instance which triggered the hook.</li>
<li><strong>firmware_name</strong> (<em>str</em>) – The name of the parsed capability</li>
<li><strong>firmware_data</strong> (<em>dict</em>) – All data contained in the <code class="docutils literal"><span class="pre">M115</span></code> report</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
<div class="section" id="octoprint-comm-firmware-protocol-capabilities">
<span id="sec-plugins-hook-comm-protocol-firmware-capabilities"></span><h3><a class="toc-backref" href="#id62">octoprint.comm.firmware.protocol.capabilities</a><a class="headerlink" href="#octoprint-comm-firmware-protocol-capabilities" title="Permalink to this headline">¶</a></h3>
<dl class="function">
<dt id="firmware_capability_hook">
<code class="descname">firmware_capability_hook</code><span class="sig-paren">(</span><em>comm_instance</em>, <em>capability</em>, <em>enabled</em>, <em>already_defined</em>, <em>*args</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#firmware_capability_hook" title="Permalink to this definition">¶</a></dt>
<dd><p>Be notified of capability report entries received from the printer.</p>
<p>Hook handlers may use this to react to custom firmware capabilities. OctoPrint parses the received capability
line and provides the parsed <code class="docutils literal"><span class="pre">capability</span></code> and whether it’s <code class="docutils literal"><span class="pre">enabled</span></code> to the handler. Additionally all already
parsed capabilities will also be provided.</p>
<p>Note that hook handlers will be called once per received capability line.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>Make sure to not perform any computationally expensive or otherwise long running actions within these handlers as
you will effectively block the receive loop, causing the communication with the printer to stall.</p>
<p class="last">This includes I/O of any kind.</p>
</div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>comm_instance</strong> (<em>object</em>) – The <code class="xref py py-class docutils literal"><span class="pre">MachineCom</span></code> instance which triggered the hook.</li>
<li><strong>capability</strong> (<em>str</em>) – The name of the parsed capability</li>
<li><strong>enabled</strong> (<em>bool</em>) – Whether the capability is reported as enabled or disabled</li>
<li><strong>already_defined</strong> (<em>dict</em>) – Already defined capabilities (capability name mapped to enabled flag)</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
<div class="section" id="octoprint-comm-protocol-action">
<span id="sec-plugins-hook-comm-protocol-action"></span><h3><a class="toc-backref" href="#id63">octoprint.comm.protocol.action</a><a class="headerlink" href="#octoprint-comm-protocol-action" title="Permalink to this headline">¶</a></h3>
<dl class="function">
<dt id="protocol_action_hook">
<code class="descname">protocol_action_hook</code><span class="sig-paren">(</span><em>comm_instance</em>, <em>line</em>, <em>action</em>, <em>*args</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#protocol_action_hook" title="Permalink to this definition">¶</a></dt>
<dd><p>React to a <a class="reference internal" href="../features/action_commands.html#sec-features-action-commands"><span class="std std-ref">action command</span></a> received from the printer.</p>
<p>Hook handlers may use this to react to custom firmware messages. OctoPrint parses the received action
command <code class="docutils literal"><span class="pre">line</span></code> and provides the parsed <code class="docutils literal"><span class="pre">action</span></code> (so anything after <code class="docutils literal"><span class="pre">//</span> <span class="pre">action:</span></code>) to the hook handler.</p>
<p>No returned value is expected.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>Make sure to not perform any computationally expensive or otherwise long running actions within your handlers as
you will effectively block the receive loop, causing the communication with the printer to stall.</p>
<p class="last">This includes I/O of any kind.</p>
</div>
<p><strong>Example:</strong></p>
<p>Logs if the <code class="docutils literal"><span class="pre">custom</span></code> action (<code class="docutils literal"><span class="pre">//</span> <span class="pre">action:custom</span></code>) is received from the printer’s firmware.</p>
<div class="literal-block-wrapper docutils container" id="id9">
<div class="code-block-caption"><span class="caption-number">Listing 19 </span><span class="caption-text"><a class="reference external" href="https://github.com/OctoPrint/Plugin-Examples/blob/master/custom_action_command.py">custom_action_command.py</a></span><a class="headerlink" href="#id9" title="Permalink to this code">¶</a></div>
<div class="highlight-default"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># coding=utf-8</span>

<span class="kn">import</span> <span class="nn">octoprint.plugin</span>

<span class="k">class</span> <span class="nc">CustomActionCommandPlugin</span><span class="p">(</span><span class="n">octoprint</span><span class="o">.</span><span class="n">plugin</span><span class="o">.</span><span class="n">OctoPrintPlugin</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">custom_action_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comm</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;custom&quot;</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Received </span><span class="se">\&quot;</span><span class="s2">custom</span><span class="se">\&quot;</span><span class="s2"> action from printer&quot;</span><span class="p">)</span>

<span class="n">__plugin_name__</span> <span class="o">=</span> <span class="s2">&quot;Custom action command&quot;</span>
<span class="n">__plugin_pythoncompat__</span> <span class="o">=</span> <span class="s2">&quot;&gt;=2.7,&lt;4&quot;</span>

<span class="k">def</span> <span class="nf">__plugin_load__</span><span class="p">():</span>
    <span class="n">plugin</span> <span class="o">=</span> <span class="n">CustomActionCommandPlugin</span><span class="p">()</span>

    <span class="k">global</span> <span class="n">__plugin_implementation__</span>
    <span class="n">__plugin_implementation__</span> <span class="o">=</span> <span class="n">plugin</span>

    <span class="k">global</span> <span class="n">__plugin_hooks__</span>
    <span class="n">__plugin_hooks__</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;octoprint.comm.protocol.action&quot;</span><span class="p">:</span> <span class="n">plugin</span><span class="o">.</span><span class="n">custom_action_handler</span><span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>comm_instance</strong> (<em>object</em>) – The <code class="xref py py-class docutils literal"><span class="pre">MachineCom</span></code> instance which triggered the hook.</li>
<li><strong>line</strong> (<em>str</em>) – The complete line as received from the printer, format <code class="docutils literal"><span class="pre">//</span> <span class="pre">action:&lt;command&gt;</span></code></li>
<li><strong>action</strong> (<em>str</em>) – The parsed out action command, so for a <code class="docutils literal"><span class="pre">line</span></code> like <code class="docutils literal"><span class="pre">//</span> <span class="pre">action:some_command</span></code> this will be
<code class="docutils literal"><span class="pre">some_command</span></code></li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
<div class="section" id="octoprint-comm-protocol-atcommand-phase">
<span id="sec-plugins-hook-comm-protocol-atcommand-phase"></span><h3><a class="toc-backref" href="#id64">octoprint.comm.protocol.atcommand.&lt;phase&gt;</a><a class="headerlink" href="#octoprint-comm-protocol-atcommand-phase" title="Permalink to this headline">¶</a></h3>
<p>This describes actually two hooks:</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal"><span class="pre">octoprint.comm.protocol.atcommand.queuing</span></code></li>
<li><code class="docutils literal"><span class="pre">octoprint.comm.protocol.atcommand.sending</span></code></li>
</ul>
</div></blockquote>
<dl class="function">
<dt id="protocol_atcommandphase_hook">
<code class="descname">protocol_atcommandphase_hook</code><span class="sig-paren">(</span><em>comm_instance</em>, <em>phase</em>, <em>command</em>, <em>parameters</em>, <em>tags=None</em>, <em>*args</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#protocol_atcommandphase_hook" title="Permalink to this definition">¶</a></dt>
<dd><p>Trigger on <a class="reference internal" href="../features/atcommands.html#sec-features-atcommands"><span class="std std-ref">&#64; commands</span></a> as they progress through the <code class="docutils literal"><span class="pre">queuing</span></code> and <code class="docutils literal"><span class="pre">sending</span></code>
phases of the comm layer. See <a class="reference internal" href="#sec-plugins-hook-comm-protocol-gcode-phase"><span class="std std-ref">the gcode phase hook</span></a> for a
detailed description of each of these phases.</p>
<p>Hook handlers may use this to react to arbitrary <a class="reference internal" href="../features/atcommands.html#sec-features-atcommands"><span class="std std-ref">&#64; commands</span></a> included in GCODE files
streamed to the printer or sent as part of GCODE scripts, through the API or plugins.</p>
<p>Please note that these hooks do not allow to rewrite, suppress or expand &#64; commands, they are merely callbacks to
trigger the <em>actual execution</em> of whatever functionality lies behind a given &#64; command, similar to
<a class="reference internal" href="#sec-plugins-hook-comm-protocol-action"><span class="std std-ref">the action command hook</span></a>.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>Make sure to not perform any computationally expensive or otherwise long running actions within your handlers as
you will effectively block the send/receive loops, causing the communication with the printer to stall.</p>
<p class="last">This includes I/O of any kind.</p>
</div>
<p><strong>Example</strong></p>
<p>Pause the print on <code class="docutils literal"><span class="pre">&#64;wait</span></code> (this mirrors the implementation of the built-in <code class="docutils literal"><span class="pre">&#64;pause</span></code> command, just with a
different name).</p>
<div class="literal-block-wrapper docutils container" id="id10">
<div class="code-block-caption"><span class="caption-number">Listing 20 </span><span class="caption-text"><a class="reference external" href="https://github.com/OctoPrint/Plugin-Examples/blob/master/custom_atcommand.py">custom_action_command.py</a></span><a class="headerlink" href="#id10" title="Permalink to this code">¶</a></div>
<div class="highlight-default"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># coding=utf-8</span>

<span class="k">def</span> <span class="nf">custom_atcommand_handler</span><span class="p">(</span><span class="n">comm</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">command</span> <span class="o">!=</span> <span class="s2">&quot;wait&quot;</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">tags</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">if</span> <span class="s2">&quot;script:afterPrintPaused&quot;</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
        <span class="c1"># This makes sure we don&#39;t run into an infinite loop if the user included @wait in the afterPrintPaused</span>
        <span class="c1"># GCODE script for whatever reason</span>
        <span class="k">return</span>

    <span class="n">comm</span><span class="o">.</span><span class="n">setPause</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">)</span>

<span class="n">__plugin_name__</span> <span class="o">=</span> <span class="s2">&quot;Custom @ command&quot;</span>
<span class="n">__plugin_pythoncompat__</span> <span class="o">=</span> <span class="s2">&quot;&gt;=2.7,&lt;4&quot;</span>
<span class="n">__plugin_hooks__</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;octoprint.comm.protocol.atcommand.queuing&quot;</span><span class="p">:</span> <span class="n">custom_atcommand_handler</span><span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>comm_instance</strong> (<em>object</em>) – The <code class="xref py py-class docutils literal"><span class="pre">MachineCom</span></code> instance which triggered the hook.</li>
<li><strong>phase</strong> (<em>str</em>) – The current phase in the command progression, either <code class="docutils literal"><span class="pre">queuing</span></code> or <code class="docutils literal"><span class="pre">sending</span></code>. Will always
match the <code class="docutils literal"><span class="pre">&lt;phase&gt;</span></code> of the hook.</li>
<li><strong>cmd</strong> (<em>str</em>) – The &#64; command without the leading &#64;</li>
<li><strong>parameters</strong> (<em>str</em>) – Any parameters provided to the &#64; command. If none were provided this will be an empty string.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
<div class="section" id="octoprint-comm-protocol-gcode-phase">
<span id="sec-plugins-hook-comm-protocol-gcode-phase"></span><h3><a class="toc-backref" href="#id65">octoprint.comm.protocol.gcode.&lt;phase&gt;</a><a class="headerlink" href="#octoprint-comm-protocol-gcode-phase" title="Permalink to this headline">¶</a></h3>
<p>This describes actually four hooks:</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal"><span class="pre">octoprint.comm.protocol.gcode.queuing</span></code></li>
<li><code class="docutils literal"><span class="pre">octoprint.comm.protocol.gcode.queued</span></code></li>
<li><code class="docutils literal"><span class="pre">octoprint.comm.protocol.gcode.sending</span></code></li>
<li><code class="docutils literal"><span class="pre">octoprint.comm.protocol.gcode.sent</span></code></li>
</ul>
</div></blockquote>
<dl class="function">
<dt id="protocol_gcodephase_hook">
<code class="descname">protocol_gcodephase_hook</code><span class="sig-paren">(</span><em>comm_instance</em>, <em>phase</em>, <em>cmd</em>, <em>cmd_type</em>, <em>gcode</em>, <em>subcode=None</em>, <em>tags=None</em>, <em>*args</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#protocol_gcodephase_hook" title="Permalink to this definition">¶</a></dt>
<dd><p>Pre- and postprocess commands as they progress through the various phases of being sent to the printer. The phases
are the following:</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal"><span class="pre">queuing</span></code>: This phase is triggered just before the command is added to the send queue of the communication layer. This
corresponds to the moment a command is being read from a file that is currently being printed. Handlers
may suppress or change commands or their command type here. This is the only phase that supports multi command
expansion by having the handler return a list, see below for details.</li>
<li><code class="docutils literal"><span class="pre">queued</span></code>: This phase is triggered just after the command was added to the send queue of the communication layer.
No manipulation is possible here anymore (returned values will be ignored).</li>
<li><code class="docutils literal"><span class="pre">sending</span></code>: This phase is triggered just before the command is actually being sent to the printer. Right afterwards
a line number will be assigned and the command will be sent. Handlers may suppress or change commands here. The
command type is not taken into account anymore.</li>
<li><code class="docutils literal"><span class="pre">sent</span></code>: This phase is triggered just after the command was handed over to the serial connection to the printer.
No manipulation is possible here anymore (returned values will be ignored). A command that reaches the sent phase
must not necessarily have reached the printer yet and it might also still run into communication problems and a
resend might be triggered for it.</li>
</ul>
</div></blockquote>
<p>Hook handlers may use this to rewrite or completely suppress certain commands before they enter the send queue of
the communication layer or before they are actually sent over the serial port, or to react to the queuing or sending
of commands after the fact. The hook handler will be called with the processing <code class="docutils literal"><span class="pre">phase</span></code>, the <code class="docutils literal"><span class="pre">cmd</span></code> to be sent to
the printer as well as the <code class="docutils literal"><span class="pre">cmd_type</span></code> parameter used for enqueuing (OctoPrint will make sure that the send queue
will never contain more than one line with the same <code class="docutils literal"><span class="pre">cmd_type</span></code>) and the detected <code class="docutils literal"><span class="pre">gcode</span></code> command (if it is one)
as well as its <code class="docutils literal"><span class="pre">subcode</span></code> (if it has one). OctoPrint will also provide any <code class="docutils literal"><span class="pre">tags</span></code> attached to the command throughout
its lifecycle.</p>
<p>Tags are arbitrary strings that can be attached to a command as it moves through the various phases and can be used to e.g.
distinguish between commands that originated in a printed file (<code class="docutils literal"><span class="pre">source:file</span></code>) vs. a configured GCODE script
(<code class="docutils literal"><span class="pre">source:script</span></code>) vs. an API call (<code class="docutils literal"><span class="pre">source:api</span></code>) vs. a plugin (<code class="docutils literal"><span class="pre">source:plugin</span></code> or <code class="docutils literal"><span class="pre">source:rewrite</span></code> and
<code class="docutils literal"><span class="pre">plugin:&lt;plugin</span> <span class="pre">identifier&gt;</span></code>). If during development you want to get an idea of the various possible tags, set
the logger <code class="docutils literal"><span class="pre">octoprint.util.comm.command_phases</span></code>  to <code class="docutils literal"><span class="pre">DEBUG</span></code>, connect to a printer (real or virtual) and take a
look at your <code class="docutils literal"><span class="pre">octoprint.log</span></code> during serial traffic:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>2018-02-16 18:20:31,213 - octoprint.util.comm.command_phases - DEBUG - phase: queuing | command: T0 | gcode: T | tags: [ api:printer.command, source:api, trigger:printer.commands ]
2018-02-16 18:20:31,216 - octoprint.util.comm.command_phases - DEBUG - phase: queued | command: M117 Before T! | gcode: M117 | tags: [ api:printer.command, phase:queuing, plugin:multi_gcode_test, source:api, source:rewrite, trigger:printer.commands ]
2018-02-16 18:20:31,217 - octoprint.util.comm.command_phases - DEBUG - phase: sending | command: M117 Before T! | gcode: M117 | tags: [ api:printer.command, phase:queuing, plugin:multi_gcode_test, source:api, source:rewrite, trigger:printer.commands ]
2018-02-16 18:20:31,217 - octoprint.util.comm.command_phases - DEBUG - phase: queued | command: T0 | gcode: T | tags: [ api:printer.command, source:api, trigger:printer.commands ]
2018-02-16 18:20:31,219 - octoprint.util.comm.command_phases - DEBUG - phase: queued | command: M117 After T! | gcode: M117 | tags: [ api:printer.command, phase:queuing, plugin:multi_gcode_test, source:api, source:rewrite, trigger:printer.commands ]
2018-02-16 18:20:31,220 - octoprint.util.comm.command_phases - DEBUG - phase: sent | command: M117 Before T! | gcode: M117 | tags: [ api:printer.command, phase:queuing, plugin:multi_gcode_test, source:api, source:rewrite, trigger:printer.commands ]
2018-02-16 18:20:31,230 - tornado.access - INFO - 204 POST /api/printer/command (127.0.0.1) 23.00ms
2018-02-16 18:20:31,232 - tornado.access - INFO - 200 POST /api/printer/command (127.0.0.1) 25.00ms
2018-02-16 18:20:31,232 - octoprint.util.comm.command_phases - DEBUG - phase: sending | command: T0 | gcode: T | tags: [ api:printer.command, source:api, trigger:printer.commands ]
2018-02-16 18:20:31,234 - octoprint.util.comm.command_phases - DEBUG - phase: sent | command: T0 | gcode: T | tags: [ api:printer.command, source:api, trigger:printer.commands ]
2018-02-16 18:20:31,242 - octoprint.util.comm.command_phases - DEBUG - phase: sending | command: M117 After T! | gcode: M117 | tags: [ api:printer.command, phase:queuing, plugin:multi_gcode_test, source:api, source:rewrite, trigger:printer.commands ]
2018-02-16 18:20:31,243 - octoprint.util.comm.command_phases - DEBUG - phase: sent | command: M117 After T! | gcode: M117 | tags: [ api:printer.command, phase:queuing, plugin:multi_gcode_test, source:api, source:rewrite, trigger:printer.commands ]
2018-02-16 18:20:38,552 - octoprint.util.comm.command_phases - DEBUG - phase: queuing | command: G91 | gcode: G91 | tags: [ api:printer.printhead, source:api, trigger:printer.commands, trigger:printer.jog ]
2018-02-16 18:20:38,552 - octoprint.util.comm.command_phases - DEBUG - phase: queued | command: G91 | gcode: G91 | tags: [ api:printer.printhead, source:api, trigger:printer.commands, trigger:printer.jog ]
2018-02-16 18:20:38,553 - octoprint.util.comm.command_phases - DEBUG - phase: sending | command: G91 | gcode: G91 | tags: [ api:printer.printhead, source:api, trigger:printer.commands, trigger:printer.jog ]
2018-02-16 18:20:38,553 - octoprint.util.comm.command_phases - DEBUG - phase: queuing | command: G1 X10 F6000 | gcode: G1 | tags: [ api:printer.printhead, source:api, trigger:printer.commands, trigger:printer.jog ]
2018-02-16 18:20:38,555 - octoprint.util.comm.command_phases - DEBUG - phase: queued | command: G1 X10 F6000 | gcode: G1 | tags: [ api:printer.printhead, source:api, trigger:printer.commands, trigger:printer.jog ]
2018-02-16 18:20:38,556 - octoprint.util.comm.command_phases - DEBUG - phase: sent | command: G91 | gcode: G91 | tags: [ api:printer.printhead, source:api, trigger:printer.commands, trigger:printer.jog ]
2018-02-16 18:20:38,556 - octoprint.util.comm.command_phases - DEBUG - phase: queuing | command: G90 | gcode: G90 | tags: [ api:printer.printhead, source:api, trigger:printer.commands, trigger:printer.jog ]
2018-02-16 18:20:38,558 - octoprint.util.comm.command_phases - DEBUG - phase: queued | command: G90 | gcode: G90 | tags: [ api:printer.printhead, source:api, trigger:printer.commands, trigger:printer.jog ]
</pre></div>
</div>
<p>Defining a <code class="docutils literal"><span class="pre">cmd_type</span></code> other than None will make sure OctoPrint takes care of only having one command of that type
in its sending queue. Predefined types are <code class="docutils literal"><span class="pre">temperature_poll</span></code> for temperature polling via <code class="docutils literal"><span class="pre">M105</span></code> and
<code class="docutils literal"><span class="pre">sd_status_poll</span></code> for polling the SD printing status via <code class="docutils literal"><span class="pre">M27</span></code>.</p>
<p><code class="docutils literal"><span class="pre">phase</span></code> will always match the <code class="docutils literal"><span class="pre">&lt;phase&gt;</span></code> part of the implemented hook (e.g. <code class="docutils literal"><span class="pre">octoprint.comm.protocol.gcode.queued</span></code>
handlers will always be called with <code class="docutils literal"><span class="pre">phase</span></code> set to <code class="docutils literal"><span class="pre">queued</span></code>). This parameter is provided so that plugins may
utilize the same hook for multiple phases if required.</p>
<p>Handlers are expected to return one of the following result variants:</p>
<blockquote>
<div><ul>
<li><p class="first"><code class="docutils literal"><span class="pre">None</span></code>: Don’t change anything. Note that Python functions will also automatically return <code class="docutils literal"><span class="pre">None</span></code> if
an empty <code class="docutils literal"><span class="pre">return</span></code> statement is used or just nothing is returned explicitly from the handler. Hence, the following
examples are all falling into this category and equivalent:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">one</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;I return None explicitly&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span>

<span class="k">def</span> <span class="nf">two</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;I just return without any values&quot;</span><span class="p">)</span>
    <span class="k">return</span>

<span class="k">def</span> <span class="nf">three</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;I don&#39;t explicitly return anything at all&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Handlers which do not wish to modify (or suppress) <code class="docutils literal"><span class="pre">cmd</span></code> or <code class="docutils literal"><span class="pre">cmd_type</span></code> at all should use this option.</p>
</li>
<li><p class="first">A string with the rewritten version of the <code class="docutils literal"><span class="pre">cmd</span></code>, e.g. <code class="docutils literal"><span class="pre">return</span> <span class="pre">&quot;M110&quot;</span></code>. To avoid situations which will be
difficult to debug should the returned command be later changed to <code class="docutils literal"><span class="pre">None</span></code> (with the intent to suppress the
command instead but actually causing <code class="docutils literal"><span class="pre">cmd</span></code> and <code class="docutils literal"><span class="pre">cmd_type</span></code> to just staying as-is), this variant should be
entirely avoided by handlers.</p>
</li>
<li><p class="first">A 1-tuple consisting of a rewritten version of the <code class="docutils literal"><span class="pre">cmd</span></code>, e.g. <code class="docutils literal"><span class="pre">return</span> <span class="pre">&quot;M110&quot;,</span></code>, or <code class="docutils literal"><span class="pre">None</span></code> in order to
suppress the command, e.g. <code class="docutils literal"><span class="pre">return</span> <span class="pre">None,</span></code>. Handlers which wish to rewrite the command or to suppress it completely
should use this option.</p>
</li>
<li><p class="first">A 2-tuple consisting of a rewritten version of the <code class="docutils literal"><span class="pre">cmd</span></code> and the <code class="docutils literal"><span class="pre">cmd_type</span></code>, e.g. <code class="docutils literal"><span class="pre">return</span> <span class="pre">&quot;M105&quot;,</span> <span class="pre">&quot;temperature_poll&quot;</span></code>.
Handlers which wish to rewrite both the command and the command type should use this option.</p>
</li>
<li><p class="first">A 3-tuple consisting of a rewritten version of the <code class="docutils literal"><span class="pre">cmd</span></code>, the <code class="docutils literal"><span class="pre">cmd_type</span></code> and any additional <code class="docutils literal"><span class="pre">tags</span></code> you might
want to attach to the lifecycle of the command in a set, e.g. <code class="docutils literal"><span class="pre">return</span> <span class="pre">&quot;M105&quot;,</span> <span class="pre">&quot;temperature_poll&quot;,</span> <span class="pre">{&quot;my_custom_tag&quot;}</span></code></p>
</li>
<li><p class="first"><strong>“queuing” phase only</strong>: A list of any of the above to allow for expanding one command into
many. The following example shows how any queued command could be turned into a sequence of a temperature query,
line number reset, display of the <code class="docutils literal"><span class="pre">gcode</span></code> on the printer’s display and finally the actual command (this example
does not make a lot of sense to be quite honest):</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">rewrite_foo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comm_instance</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">cmd_type</span><span class="p">,</span> <span class="n">gcode</span><span class="p">,</span> <span class="n">subcode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="kc">None</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">gcode</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">cmd</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;@foo&quot;</span><span class="p">):</span>
        <span class="k">return</span>

    <span class="k">return</span> <span class="p">[(</span><span class="s2">&quot;M105&quot;</span><span class="p">,</span> <span class="s2">&quot;temperature_poll&quot;</span><span class="p">),</span>    <span class="c1"># 2-tuple, command &amp; command type</span>
            <span class="p">(</span><span class="s2">&quot;M110&quot;</span><span class="p">,),</span>                       <span class="c1"># 1-tuple, just the command</span>
            <span class="s2">&quot;M117 echo foo: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmd</span><span class="p">)]</span> <span class="c1"># string, just the command</span>

<span class="n">__plugin_hooks__</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;octoprint.comm.protocol.gcode.queuing&quot;</span><span class="p">:</span> <span class="n">rewrite_foo</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
</ul>
<p>Note: Only one command of a given <code class="docutils literal"><span class="pre">cmd_type</span></code> (other than None) may be queued at a time. Trying to rewrite the <code class="docutils literal"><span class="pre">cmd_type</span></code>
to one already in the queue will give an error.</p>
</div></blockquote>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>Make sure to not perform any computationally expensive or otherwise long running actions within these handlers as
you will effectively block the send loop, causing the communication with the printer to stall.</p>
<p class="last">This includes I/O of any kind.</p>
</div>
<p><strong>Example</strong></p>
<p>The following hook handler replaces all <code class="docutils literal"><span class="pre">M107</span></code> (“Fan Off”, deprecated) with an <code class="docutils literal"><span class="pre">M106</span> <span class="pre">S0</span></code> (“Fan On” with speed
parameter) upon queuing and logs all sent <code class="docutils literal"><span class="pre">M106</span></code>.</p>
<div class="literal-block-wrapper docutils container" id="id11">
<div class="code-block-caption"><span class="caption-number">Listing 21 </span><span class="caption-text"><a class="reference external" href="https://github.com/OctoPrint/Plugin-Examples/blob/master/rewrite_m107.py">rewrite_m107.py</a></span><a class="headerlink" href="#id11" title="Permalink to this code">¶</a></div>
<div class="highlight-default"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># coding=utf-8</span>

<span class="kn">import</span> <span class="nn">octoprint.plugin</span>

<span class="k">class</span> <span class="nc">RewriteM107Plugin</span><span class="p">(</span><span class="n">octoprint</span><span class="o">.</span><span class="n">plugin</span><span class="o">.</span><span class="n">OctoPrintPlugin</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">rewrite_m107</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comm_instance</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">cmd_type</span><span class="p">,</span> <span class="n">gcode</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">gcode</span> <span class="ow">and</span> <span class="n">gcode</span> <span class="o">==</span> <span class="s2">&quot;M107&quot;</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;M106 S0&quot;</span>
        <span class="k">return</span> <span class="n">cmd</span><span class="p">,</span>

    <span class="k">def</span> <span class="nf">sent_m106</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comm_instance</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">cmd_type</span><span class="p">,</span> <span class="n">gcode</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">gcode</span> <span class="ow">and</span> <span class="n">gcode</span> <span class="o">==</span> <span class="s2">&quot;M106&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Just sent M106: </span><span class="si">{cmd}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">()))</span>

<span class="n">__plugin_name__</span> <span class="o">=</span> <span class="s2">&quot;Rewrite M107&quot;</span>
<span class="n">__plugin_pythoncompat__</span> <span class="o">=</span> <span class="s2">&quot;&gt;=2.7,&lt;4&quot;</span>
<span class="k">def</span> <span class="nf">__plugin_load__</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">__plugin_implementation__</span>
    <span class="n">__plugin_implementation__</span> <span class="o">=</span> <span class="n">RewriteM107Plugin</span><span class="p">()</span>

    <span class="k">global</span> <span class="n">__plugin_hooks__</span>
    <span class="n">__plugin_hooks__</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;octoprint.comm.protocol.gcode.queuing&quot;</span><span class="p">:</span> <span class="n">__plugin_implementation__</span><span class="o">.</span><span class="n">rewrite_m107</span><span class="p">,</span>
        <span class="s2">&quot;octoprint.comm.protocol.gcode.sent&quot;</span><span class="p">:</span> <span class="n">__plugin_implementation__</span><span class="o">.</span><span class="n">sent_m106</span>
    <span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>comm_instance</strong> (<em>object</em>) – The <code class="xref py py-class docutils literal"><span class="pre">MachineCom</span></code> instance which triggered the hook.</li>
<li><strong>phase</strong> (<em>str</em>) – The current phase in the command progression, either <code class="docutils literal"><span class="pre">queuing</span></code>, <code class="docutils literal"><span class="pre">queued</span></code>, <code class="docutils literal"><span class="pre">sending</span></code> or
<code class="docutils literal"><span class="pre">sent</span></code>. Will always match the <code class="docutils literal"><span class="pre">&lt;phase&gt;</span></code> of the hook.</li>
<li><strong>cmd</strong> (<em>str</em>) – The GCODE command for which the hook was triggered. This is the full command as taken either
from the currently streamed GCODE file or via other means (e.g. user input our status polling).</li>
<li><strong>cmd_type</strong> (<em>str</em>) – Type of command, e.g. <code class="docutils literal"><span class="pre">temperature_poll</span></code> for temperature polling or <code class="docutils literal"><span class="pre">sd_status_poll</span></code> for SD
printing status polling.</li>
<li><strong>gcode</strong> (<em>str</em>) – Parsed GCODE command, e.g. <code class="docutils literal"><span class="pre">G0</span></code> or <code class="docutils literal"><span class="pre">M110</span></code>, may also be None if no known command could be parsed</li>
<li><strong>subcode</strong> (<em>str</em>) – Parsed subcode of the GCODE command, e.g. <code class="docutils literal"><span class="pre">1</span></code> for <code class="docutils literal"><span class="pre">M80.1</span></code>. Will be None if no subcode was provided
or no command could be parsed.</li>
<li><strong>tags</strong> – Tags attached to the command</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">None, 1-tuple, 2-tuple or string, see the description above for details.</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
<div class="section" id="octoprint-comm-protocol-gcode-received">
<span id="sec-plugins-hook-comm-protocol-gcode-received"></span><h3><a class="toc-backref" href="#id66">octoprint.comm.protocol.gcode.received</a><a class="headerlink" href="#octoprint-comm-protocol-gcode-received" title="Permalink to this headline">¶</a></h3>
<dl class="function">
<dt id="gcode_received_hook">
<code class="descname">gcode_received_hook</code><span class="sig-paren">(</span><em>comm_instance</em>, <em>line</em>, <em>*args</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#gcode_received_hook" title="Permalink to this definition">¶</a></dt>
<dd><p>Get the returned lines sent by the printer. Handlers should return the received line or in any case, the modified
version of it. If the handler returns None, processing will be aborted and the communication layer will get an
empty string as the received line. Note that Python functions will also automatically return <code class="docutils literal"><span class="pre">None</span></code> if an empty
<code class="docutils literal"><span class="pre">return</span></code> statement is used or just nothing is returned explicitly from the handler.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>Make sure to not perform any computationally expensive or otherwise long running actions within these handlers as
you will effectively block the receive loop, causing the communication with the printer to stall.</p>
<p class="last">This includes I/O of any kind.</p>
</div>
<p><strong>Example:</strong></p>
<p>Looks for the response of an <code class="docutils literal"><span class="pre">M115</span></code>, which contains information about the <code class="docutils literal"><span class="pre">MACHINE_TYPE</span></code>, among other things.</p>
<div class="literal-block-wrapper docutils container" id="id12">
<div class="code-block-caption"><span class="caption-number">Listing 22 </span><span class="caption-text"><a class="reference external" href="https://github.com/OctoPrint/Plugin-Examples/blob/master/read_m115_response.py">read_m115_response.py</a></span><a class="headerlink" href="#id12" title="Permalink to this code">¶</a></div>
<div class="highlight-default"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># coding=utf-8</span>

<span class="kn">import</span> <span class="nn">logging</span>

<span class="k">def</span> <span class="nf">detect_machine_type</span><span class="p">(</span><span class="n">comm</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="s2">&quot;MACHINE_TYPE&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">line</span>

    <span class="kn">from</span> <span class="nn">octoprint.util.comm</span> <span class="kn">import</span> <span class="n">parse_firmware_line</span>

    <span class="c1"># Create a dict with all the keys/values returned by the M115 request</span>
    <span class="n">printer_data</span> <span class="o">=</span> <span class="n">parse_firmware_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;octoprint.plugin.&quot;</span> <span class="o">+</span> <span class="vm">__name__</span><span class="p">)</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Machine type detected: </span><span class="si">{machine}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">machine</span><span class="o">=</span><span class="n">printer_data</span><span class="p">[</span><span class="s2">&quot;MACHINE_TYPE&quot;</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">line</span>

<span class="n">__plugin_name__</span> <span class="o">=</span> <span class="s2">&quot;Detect Machine Data&quot;</span>
<span class="n">__plugin_pythoncompat__</span> <span class="o">=</span> <span class="s2">&quot;&gt;=2.7,&lt;4&quot;</span>
<span class="n">__plugin_hooks__</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;octoprint.comm.protocol.gcode.received&quot;</span><span class="p">:</span> <span class="n">detect_machine_type</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>comm_instance</strong> (<em>MachineCom</em>) – The <code class="xref py py-class docutils literal"><span class="pre">MachineCom</span></code> instance which triggered the hook.</li>
<li><strong>line</strong> (<em>str</em>) – The line received from the printer.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first">The received line or in any case, a modified version of it.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Return type:</th><td class="field-body"><p class="first last">str</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
<div class="section" id="octoprint-comm-protocol-gcode-error">
<span id="sec-plugins-hook-comm-protocol-gcode-error"></span><h3><a class="toc-backref" href="#id67">octoprint.comm.protocol.gcode.error</a><a class="headerlink" href="#octoprint-comm-protocol-gcode-error" title="Permalink to this headline">¶</a></h3>
<dl class="function">
<dt id="gcode_error_hook">
<code class="descname">gcode_error_hook</code><span class="sig-paren">(</span><em>comm_instance</em>, <em>error_message</em>, <em>*args</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#gcode_error_hook" title="Permalink to this definition">¶</a></dt>
<dd><p>Get the messages of any errors messages sent by the printer, with the leading <code class="docutils literal"><span class="pre">Error:</span></code> or <code class="docutils literal"><span class="pre">!!</span></code> already
stripped. Handlers should return True if they handled that error internally and it should not be processed by
the system further. Normal processing of these kinds of errors - depending on the configuration of error
handling - involves canceling the ongoing print and possibly also disconnecting.</p>
<p>Plugins might utilize this hook to handle errors generated by the printer that are recoverable in one way or
the other and should not trigger the normal handling that assumes the worst.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>Make sure to not perform any computationally expensive or otherwise long running actions within these handlers as
you will effectively block the receive loop, causing the communication with the printer to stall.</p>
<p class="last">This includes I/O of any kind.</p>
</div>
<p><strong>Example:</strong></p>
<p>Looks for error messages containing “fan error” or “bed missing” (ignoring case) and marks them as handled by the
plugin.</p>
<div class="literal-block-wrapper docutils container" id="id13">
<div class="code-block-caption"><span class="caption-number">Listing 23 </span><span class="caption-text"><a class="reference external" href="https://github.com/OctoPrint/Plugin-Examples/blob/master/comm_error_handler_test.py">comm_error_handler_test.py</a></span><a class="headerlink" href="#id13" title="Permalink to this code">¶</a></div>
<div class="highlight-default"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">logging</span>

<span class="n">_HANDLED_ERRORS</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;fan error&#39;</span><span class="p">,</span> <span class="s1">&#39;bed missing&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">handle_error</span><span class="p">(</span><span class="n">comm</span><span class="p">,</span> <span class="n">error_message</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">lower_error</span> <span class="o">=</span> <span class="n">error_message</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lower_error</span><span class="p">,</span> <span class="n">_HANDLED_ERRORS</span><span class="p">)):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;octoprint.plugin.error_handler_test&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Error </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2"> is handled by this plugin&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">error_message</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">True</span>

<span class="n">__plugin_name__</span> <span class="o">=</span> <span class="s2">&quot;Comm Error Handler Test&quot;</span>
<span class="n">__plugin_pythoncompat__</span> <span class="o">=</span> <span class="s2">&quot;&gt;=2.7,&lt;4&quot;</span>
<span class="n">__plugin_hooks__</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;octoprint.comm.protocol.gcode.error&quot;</span><span class="p">:</span> <span class="n">handle_error</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>comm_instance</strong> (<em>MachineCom</em>) – The <code class="xref py py-class docutils literal"><span class="pre">MachineCom</span></code> instance which triggered the hook.</li>
<li><strong>error_message</strong> (<em>str</em>) – The error message received from the printer.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first">True if the error was handled in the plugin and should not be processed further, False (or None) otherwise.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Return type:</th><td class="field-body"><p class="first last">bool</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
<div class="section" id="octoprint-comm-protocol-scripts">
<span id="sec-plugins-hook-comm-protocol-scripts"></span><h3><a class="toc-backref" href="#id68">octoprint.comm.protocol.scripts</a><a class="headerlink" href="#octoprint-comm-protocol-scripts" title="Permalink to this headline">¶</a></h3>
<dl class="function">
<dt id="protocol_scripts_hook">
<code class="descname">protocol_scripts_hook</code><span class="sig-paren">(</span><em>comm_instance</em>, <em>script_type</em>, <em>script_name</em>, <em>*args</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#protocol_scripts_hook" title="Permalink to this definition">¶</a></dt>
<dd><p>Return a prefix to prepend, postfix to append, and optionally a dictionary of variables to provide to the script <code class="docutils literal"><span class="pre">script_name</span></code> of type <code class="docutils literal"><span class="pre">type</span></code>. Handlers should
make sure to only proceed with returning additional scripts if the <code class="docutils literal"><span class="pre">script_type</span></code> and <code class="docutils literal"><span class="pre">script_name</span></code> match
handled scripts. If not, None should be returned directly.</p>
<p>If the hook handler has something to add to the specified script, it may return a 2-tuple, a 3-tuple or a 4-tuple with the first entry
defining the prefix (what to <em>prepend</em> to the script in question), the second entry defining the postfix (what to
<em>append</em> to the script in question), and finally if desired a dictionary of variables to be made available to the script on third and additional tags to set on the
commands on fourth position. Both prefix and postfix can be None to signify that nothing should be prepended
respectively appended.</p>
<p>The returned prefix and postfix entries may be either iterables of script lines or a string including newlines of the script lines (which
will be split by the caller if necessary).</p>
<p><strong>Example 1:</strong></p>
<p>Appends an <code class="docutils literal"><span class="pre">M117</span> <span class="pre">OctoPrint</span> <span class="pre">connected</span></code> to the configured <code class="docutils literal"><span class="pre">afterPrinterConnected</span></code> GCODE script.</p>
<div class="literal-block-wrapper docutils container" id="id14">
<div class="code-block-caption"><span class="caption-number">Listing 24 </span><span class="caption-text"><a class="reference external" href="https://github.com/OctoPrint/Plugin-Examples/blob/master/message_on_connect.py">message_on_connect.py</a></span><a class="headerlink" href="#id14" title="Permalink to this code">¶</a></div>
<div class="highlight-default"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># coding=utf-8</span>

<span class="k">def</span> <span class="nf">message_on_connect</span><span class="p">(</span><span class="n">comm</span><span class="p">,</span> <span class="n">script_type</span><span class="p">,</span> <span class="n">script_name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">script_type</span> <span class="o">==</span> <span class="s2">&quot;gcode&quot;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">script_name</span> <span class="o">==</span> <span class="s2">&quot;afterPrinterConnected&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">prefix</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">postfix</span> <span class="o">=</span> <span class="s2">&quot;M117 OctoPrint connected&quot;</span>
    <span class="k">return</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">postfix</span>

<span class="n">__plugin_name__</span> <span class="o">=</span> <span class="s2">&quot;Message on connect&quot;</span>
<span class="n">__plugin_pythoncompat__</span> <span class="o">=</span> <span class="s2">&quot;&gt;=2.7,&lt;4&quot;</span>
<span class="n">__plugin_hooks__</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;octoprint.comm.protocol.scripts&quot;</span><span class="p">:</span> <span class="n">message_on_connect</span><span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<p><strong>Example 2:</strong></p>
<p>Provides the variable <code class="docutils literal"><span class="pre">myvariable</span></code> to the configured <code class="docutils literal"><span class="pre">beforePrintStarted</span></code> GCODE script.</p>
<div class="literal-block-wrapper docutils container" id="id15">
<div class="code-block-caption"><span class="caption-number">Listing 25 </span><span class="caption-text"><a class="reference external" href="https://github.com/OctoPrint/Plugin-Examples/blob/master/gcode_script_variables.py">gcode_script_variables.py</a></span><a class="headerlink" href="#id15" title="Permalink to this code">¶</a></div>
<div class="highlight-default"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># coding=utf-8</span>

<span class="k">def</span> <span class="nf">gcode_script_variables</span><span class="p">(</span><span class="n">comm</span><span class="p">,</span> <span class="n">script_type</span><span class="p">,</span> <span class="n">script_name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">script_type</span> <span class="o">==</span> <span class="s2">&quot;gcode&quot;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">script_name</span> <span class="o">==</span> <span class="s2">&quot;beforePrintStarted&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">prefix</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">postfix</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">variables</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">myvariable</span><span class="o">=</span><span class="s2">&quot;Hi! I&#39;m a variable!&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">postfix</span><span class="p">,</span> <span class="n">variables</span>

<span class="n">__plugin_name__</span> <span class="o">=</span> <span class="s2">&quot;gcode script variables&quot;</span>
<span class="n">__plugin_pythoncompat__</span> <span class="o">=</span> <span class="s2">&quot;&gt;=2.7,&lt;4&quot;</span>
<span class="n">__plugin_hooks__</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;octoprint.comm.protocol.scripts&quot;</span><span class="p">:</span> <span class="n">gcode_script_variables</span><span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>comm_instance</strong> (<em>MachineCom</em>) – The <code class="xref py py-class docutils literal"><span class="pre">MachineCom</span></code> instance which triggered the hook.</li>
<li><strong>script_type</strong> (<em>str</em>) – The type of the script for which the hook was called, currently only “gcode” is supported here.</li>
<li><strong>script_name</strong> (<em>str</em>) – The name of the script for which the hook was called.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first">A 2-tuple in the form <code class="docutils literal"><span class="pre">(prefix,</span> <span class="pre">postfix)</span></code>, 3-tuple in the form <code class="docutils literal"><span class="pre">(prefix,</span> <span class="pre">postfix,</span> <span class="pre">variables)</span></code>, or None</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Return type:</th><td class="field-body"><p class="first last">tuple or None</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
<div class="section" id="octoprint-comm-protocol-temperatures-received">
<span id="sec-plugins-hook-comm-protocol-temperatures-received"></span><h3><a class="toc-backref" href="#id69">octoprint.comm.protocol.temperatures.received</a><a class="headerlink" href="#octoprint-comm-protocol-temperatures-received" title="Permalink to this headline">¶</a></h3>
<dl class="function">
<dt id="protocol_temperatures_received_hook">
<code class="descname">protocol_temperatures_received_hook</code><span class="sig-paren">(</span><em>comm_instance</em>, <em>parsed_temperatures</em>, <em>*args</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#protocol_temperatures_received_hook" title="Permalink to this definition">¶</a></dt>
<dd><p>Get the parsed temperatures returned by the printer, allowing handlers to modify them prior to handing them off
to the system. Handlers are expected to either return <code class="docutils literal"><span class="pre">parsed_temperatures</span></code> as-is or a modified copy thereof.</p>
<p><code class="docutils literal"><span class="pre">parsed_temperatures</span></code> is a dictionary mapping from tool/bed identifier (<code class="docutils literal"><span class="pre">B</span></code>, <code class="docutils literal"><span class="pre">T0</span></code>, <code class="docutils literal"><span class="pre">T1</span></code>) to a 2-tuple of
actual and target temperature, e.g. <code class="docutils literal"><span class="pre">{'B':</span> <span class="pre">(45.2,</span> <span class="pre">50.0),</span> <span class="pre">'T0':</span> <span class="pre">(178.9,</span> <span class="pre">210.0),</span> <span class="pre">'T1':</span> <span class="pre">(21.3,</span> <span class="pre">0.0)}</span></code>.</p>
<p>This hook can be useful in cases where a printer e.g. is prone to returning garbage data from time to time, allowing
additional sanity checking to be applied and invalid values to be filtered out. If a handler returns an empty
dictionary or <code class="docutils literal"><span class="pre">None</span></code>, no further processing will take place.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>Make sure to not perform any computationally expensive or otherwise long running actions within these handlers as
you will effectively block the receive loop, causing the communication with the printer to stall.</p>
<p class="last">This includes I/O of any kind.</p>
</div>
<p><strong>Example</strong></p>
<p>The following example shows how to filter out actual temperatures that are outside a sane range of 1°C to 300°C.</p>
<div class="literal-block-wrapper docutils container" id="id16">
<div class="code-block-caption"><span class="caption-number">Listing 26 </span><span class="caption-text"><a class="reference external" href="https://github.com/OctoPrint/Plugin-Examples/blob/master/sanitize_temperatures.py">sanitize_temperatures.py</a></span><a class="headerlink" href="#id16" title="Permalink to this code">¶</a></div>
<div class="highlight-default"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># coding=utf-8</span>

<span class="k">def</span> <span class="nf">sanitize_temperatures</span><span class="p">(</span><span class="n">comm</span><span class="p">,</span> <span class="n">parsed_temps</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">parsed_temps</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">is_sane</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

<span class="k">def</span> <span class="nf">is_sane</span><span class="p">(</span><span class="n">actual</span><span class="p">):</span>
    <span class="k">return</span> <span class="mf">1.0</span> <span class="o">&lt;=</span> <span class="n">actual</span> <span class="o">&lt;=</span> <span class="mf">300.0</span>

<span class="n">__plugin_name__</span> <span class="o">=</span> <span class="s2">&quot;Sanitize Temperatures&quot;</span>
<span class="n">__plugin_pythoncompat__</span> <span class="o">=</span> <span class="s2">&quot;&gt;=2.7,&lt;4&quot;</span>
<span class="n">__plugin_hooks__</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;octoprint.comm.protocol.temperatures.received&quot;</span><span class="p">:</span> <span class="n">sanitize_temperatures</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
</dd></dl>

</div>
<div class="section" id="octoprint-comm-transport-serial-factory">
<span id="sec-plugins-hook-comm-transport-serial-factory"></span><h3><a class="toc-backref" href="#id70">octoprint.comm.transport.serial.factory</a><a class="headerlink" href="#octoprint-comm-transport-serial-factory" title="Permalink to this headline">¶</a></h3>
<dl class="function">
<dt id="serial_factory_hook">
<code class="descname">serial_factory_hook</code><span class="sig-paren">(</span><em>comm_instance</em>, <em>port</em>, <em>baudrate</em>, <em>read_timeout</em>, <em>*args</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#serial_factory_hook" title="Permalink to this definition">¶</a></dt>
<dd><p>Return a serial object to use as serial connection to the printer. If a handler cannot create a serial object
for the specified <code class="docutils literal"><span class="pre">port</span></code> (and <code class="docutils literal"><span class="pre">baudrate</span></code>), it should just return <code class="docutils literal"><span class="pre">None</span></code>.</p>
<p>If the hook handler needs to perform state switches (e.g. for autodetection) or other operations on the
<code class="xref py py-class docutils literal"><span class="pre">MachineCom</span></code> instance, it can use the supplied <code class="docutils literal"><span class="pre">comm_instance</span></code> to do so. Plugin
authors should keep in mind however that due to a pending change in the communication layer of
OctoPrint, that interface will change in the future. Authors are advised to follow OctoPrint’s development
closely if directly utilizing <code class="xref py py-class docutils literal"><span class="pre">MachineCom</span></code> functionality.</p>
<p>A valid serial instance is expected to provide the following methods, analogue to PySerial’s
<a class="reference external" href="https://pythonhosted.org//pyserial/pyserial_api.html#serial.Serial">serial.Serial</a>:</p>
<dl class="docutils">
<dt>readline(size=None, eol=’n’)</dt>
<dd>Reads a line from the serial connection, compare <a class="reference external" href="https://pythonhosted.org//pyserial/pyserial_api.html#serial.FileLike.readline">serial.Filelike.readline</a>.</dd>
<dt>write(data)</dt>
<dd>Writes data to the serial connection, compare <a class="reference external" href="https://pythonhosted.org//pyserial/pyserial_api.html#serial.FileLike.write">serial.Filelike.write</a>.</dd>
<dt>close()</dt>
<dd>Closes the serial connection, compare <a class="reference external" href="https://pythonhosted.org//pyserial/pyserial_api.html#serial.Serial.close">serial.Serial.close</a>.</dd>
</dl>
<p>Additionally setting the following attributes need to be supported if baudrate detection is supposed to work:</p>
<dl class="docutils">
<dt>baudrate</dt>
<dd>An integer describing the baudrate to use for the serial connection, compare <a class="reference external" href="https://pythonhosted.org//pyserial/pyserial_api.html#serial.Serial.baudrate">serial.Serial.baudrate</a>.</dd>
<dt>timeout</dt>
<dd>An integer describing the read timeout on the serial connection, compare <a class="reference external" href="https://pythonhosted.org//pyserial/pyserial_api.html#serial.Serial.timeout">serial.Serial.timeout</a>.</dd>
</dl>
<p><strong>Example:</strong></p>
<p>Serial factory similar to the default one which performs auto detection of the serial port if <code class="docutils literal"><span class="pre">port</span></code> is <code class="docutils literal"><span class="pre">None</span></code>
or <code class="docutils literal"><span class="pre">AUTO</span></code>.</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">default</span><span class="p">(</span><span class="n">comm_instance</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">baudrate</span><span class="p">,</span> <span class="n">connection_timeout</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">port</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">port</span> <span class="o">==</span> <span class="s1">&#39;AUTO&#39;</span><span class="p">:</span>
        <span class="c1"># no known port, try auto detection</span>
        <span class="n">comm_instance</span><span class="o">.</span><span class="n">_changeState</span><span class="p">(</span><span class="n">comm_instance</span><span class="o">.</span><span class="n">STATE_DETECT_SERIAL</span><span class="p">)</span>
        <span class="n">serial_obj</span> <span class="o">=</span> <span class="n">comm_instance</span><span class="o">.</span><span class="n">_detectPort</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">serial_obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">comm_instance</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot;Failed to autodetect serial port&quot;</span><span class="p">)</span>
            <span class="n">comm_instance</span><span class="o">.</span><span class="n">_errorValue</span> <span class="o">=</span> <span class="s1">&#39;Failed to autodetect serial port.&#39;</span>
            <span class="n">comm_instance</span><span class="o">.</span><span class="n">_changeState</span><span class="p">(</span><span class="n">comm_instance</span><span class="o">.</span><span class="n">STATE_ERROR</span><span class="p">)</span>
            <span class="n">eventManager</span><span class="p">()</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span><span class="n">Events</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">comm_instance</span><span class="o">.</span><span class="n">getErrorString</span><span class="p">()})</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># connect to regular serial port</span>
        <span class="n">comm_instance</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot;Connecting to: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">port</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">baudrate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">serial_obj</span> <span class="o">=</span> <span class="n">serial</span><span class="o">.</span><span class="n">Serial</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">port</span><span class="p">),</span> <span class="mi">115200</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">connection_timeout</span><span class="p">,</span> <span class="n">writeTimeout</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">parity</span><span class="o">=</span><span class="n">serial</span><span class="o">.</span><span class="n">PARITY_ODD</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">serial_obj</span> <span class="o">=</span> <span class="n">serial</span><span class="o">.</span><span class="n">Serial</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">port</span><span class="p">),</span> <span class="n">baudrate</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">connection_timeout</span><span class="p">,</span> <span class="n">writeTimeout</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">parity</span><span class="o">=</span><span class="n">serial</span><span class="o">.</span><span class="n">PARITY_ODD</span><span class="p">)</span>
        <span class="n">serial_obj</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">serial_obj</span><span class="o">.</span><span class="n">parity</span> <span class="o">=</span> <span class="n">serial</span><span class="o">.</span><span class="n">PARITY_NONE</span>
        <span class="n">serial_obj</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">serial_obj</span>
</pre></div>
</td></tr></table></div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>comm_instance</strong> (<em>MachineCom</em>) – The <code class="xref py py-class docutils literal"><span class="pre">MachineCom</span></code> instance which triggered the hook.</li>
<li><strong>port</strong> (<em>str</em>) – The port for which to construct a serial instance. May be <code class="docutils literal"><span class="pre">None</span></code> or <code class="docutils literal"><span class="pre">AUTO</span></code> in which case port
auto detection is to be performed.</li>
<li><strong>baudrate</strong> (<em>int</em>) – The baudrate for which to construct a serial instance. May be 0 in which case baudrate auto
detection is to be performed.</li>
<li><strong>read_timeout</strong> (<em>int</em>) – The read timeout to set on the serial port.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first">The constructed serial object ready for use, or <code class="docutils literal"><span class="pre">None</span></code> if the handler could not construct the object.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Return type:</th><td class="field-body"><p class="first last">A serial instance implementing implementing the methods <code class="docutils literal"><span class="pre">readline(...)</span></code>, <code class="docutils literal"><span class="pre">write(...)</span></code>, <code class="docutils literal"><span class="pre">close()</span></code> and
optionally <code class="docutils literal"><span class="pre">baudrate</span></code> and <code class="docutils literal"><span class="pre">timeout</span></code> attributes as described above.</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
<div class="section" id="octoprint-events-register-custom-events">
<span id="sec-plugins-hook-events-register-custom-events"></span><h3><a class="toc-backref" href="#id71">octoprint.events.register_custom_events</a><a class="headerlink" href="#octoprint-events-register-custom-events" title="Permalink to this headline">¶</a></h3>
<dl class="function">
<dt id="register_custom_events_hook">
<code class="descname">register_custom_events_hook</code><span class="sig-paren">(</span><em>*args</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#register_custom_events_hook" title="Permalink to this definition">¶</a></dt>
<dd><p>Return a list of custom <a class="reference internal" href="../events/index.html#sec-events"><span class="std std-ref">events</span></a> to register in the system for your plugin.</p>
<p>Should return a list of strings which represent the custom events. Their name on the <cite>octoprint.events.Events</cite> object
will be the returned value transformed into upper case <code class="docutils literal"><span class="pre">CAMEL_CASE</span></code> and prefixed with <code class="docutils literal"><span class="pre">PLUGIN_&lt;IDENTIFIER&gt;</span></code>. Their
value will be prefixed with <code class="docutils literal"><span class="pre">plugin_&lt;identifier&gt;_</span></code>.</p>
<p>Example:</p>
<p>Consider the following hook part of a plugin with the identifier <code class="docutils literal"><span class="pre">myplugin</span></code>. It will register two custom events
in the system, <code class="docutils literal"><span class="pre">octoprint.events.Events.PLUGIN_MYPLUGIN_MY_CUSTOM_EVENT</span></code> with value <code class="docutils literal"><span class="pre">plugin_myplugin_my_custom_event</span></code>
and <code class="docutils literal"><span class="pre">octoprint.events.Events.PLUGIN_MYPLUGIN_MY_OTHER_CUSTOM_EVENT</span></code> with value <code class="docutils literal"><span class="pre">plugin_myplugin_my_other_custom_event</span></code>.</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">register_custom_events</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;my_custom_event&quot;</span><span class="p">,</span> <span class="s2">&quot;my_other_custom_event&quot;</span><span class="p">]</span>
</pre></div>
</td></tr></table></div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body">A list of custom events to register</td>
</tr>
<tr class="field-even field"><th class="field-name">Return type:</th><td class="field-body">list</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
<div class="section" id="octoprint-filemanager-analysis-factory">
<span id="sec-plugins-hook-filemanager-analysis-factory"></span><h3><a class="toc-backref" href="#id72">octoprint.filemanager.analysis.factory</a><a class="headerlink" href="#octoprint-filemanager-analysis-factory" title="Permalink to this headline">¶</a></h3>
<dl class="function">
<dt id="analysis_queue_factory_hook">
<code class="descname">analysis_queue_factory_hook</code><span class="sig-paren">(</span><em>*args</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#analysis_queue_factory_hook" title="Permalink to this definition">¶</a></dt>
<dd><p>Return additional (or replacement) analysis queue factories used for analysing uploaded files.</p>
<p>Should return a dictionary to merge with the existing dictionary of factories, mapping from extension tree leaf
to analysis queue factory. Analysis queue factories are expected to be <a class="reference internal" href="../modules/filemanager.html#octoprint.filemanager.analysis.AbstractAnalysisQueue" title="octoprint.filemanager.analysis.AbstractAnalysisQueue"><code class="xref py py-class docutils literal"><span class="pre">AbstractAnalysisQueue</span></code></a>
subclasses or factory methods taking one argument (the finish callback to be used by the queue implementation
to signal that an analysis has been finished to the system). See the source of <a class="reference internal" href="../modules/filemanager.html#octoprint.filemanager.analysis.GcodeAnalysisQueue" title="octoprint.filemanager.analysis.GcodeAnalysisQueue"><code class="xref py py-class docutils literal"><span class="pre">GcodeAnalysisQueue</span></code></a>
for an example.</p>
<p>By default, only one analysis queue factory is registered in the system, for file type <code class="docutils literal"><span class="pre">gcode</span></code>: <a class="reference internal" href="../modules/filemanager.html#octoprint.filemanager.analysis.GcodeAnalysisQueue" title="octoprint.filemanager.analysis.GcodeAnalysisQueue"><code class="xref py py-class docutils literal"><span class="pre">GcodeAnalysisQueue</span></code></a>.
This can be replaced by plugins using this hook, allowing other approaches to file analysis.</p>
<p>This is useful for plugins wishing to provide (alternative) methods of metadata analysis for printable files.</p>
<p><strong>Example:</strong></p>
<p>The following handler would replace the existing analysis queue for <code class="docutils literal"><span class="pre">gcode</span></code> files with a custom implementation:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">octoprint.filemanager.analysis</span> <span class="kn">import</span> <span class="n">AbstractAnalysisQueue</span>

<span class="k">class</span> <span class="nc">MyCustomGcodeAnalysisQueue</span><span class="p">(</span><span class="n">AbstractAnalysisQueue</span><span class="p">):</span>
    <span class="c1"># ... custom implementation here ...</span>

<span class="k">def</span> <span class="nf">custom_gcode_analysis_queue</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">gcode</span><span class="o">=</span><span class="n">MyCustomGcodeAnalysisQueue</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body">A dictionary of analysis queue factories, mapped by their targeted file type.</td>
</tr>
<tr class="field-even field"><th class="field-name">Return type:</th><td class="field-body">dict</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
<div class="section" id="octoprint-filemanager-extension-tree">
<span id="sec-plugins-hook-filemanager-extensiontree"></span><h3><a class="toc-backref" href="#id73">octoprint.filemanager.extension_tree</a><a class="headerlink" href="#octoprint-filemanager-extension-tree" title="Permalink to this headline">¶</a></h3>
<dl class="function">
<dt id="file_extension_hook">
<code class="descname">file_extension_hook</code><span class="sig-paren">(</span><em>*args</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#file_extension_hook" title="Permalink to this definition">¶</a></dt>
<dd><p>Return additional entries for the tree of accepted file extensions for uploading/handling by the file manager.</p>
<p>Should return a dictionary to merge with the existing extension tree, adding additional extension groups to
<code class="docutils literal"><span class="pre">machinecode</span></code> or <code class="docutils literal"><span class="pre">model</span></code> types.</p>
<p><strong>Example:</strong></p>
<p>The following handler would add a new file type “x3g” as accepted <code class="docutils literal"><span class="pre">machinecode</span></code> format, with extensions <code class="docutils literal"><span class="pre">x3g</span></code>
and <code class="docutils literal"><span class="pre">s3g</span></code>:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">support_x3g_machinecode</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">machinecode</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">x3g</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;x3g&quot;</span><span class="p">,</span> <span class="s2">&quot;s3g&quot;</span><span class="p">]</span>
        <span class="p">)</span>
    <span class="p">)</span>
</pre></div>
</td></tr></table></div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This will only add the supplied extensions to the extension tree, allowing the files to be uploaded and managed
through the file manager. Plugins will need to add further steps to ensure that the files will be processable
in the rest of the system (e.g. handling/preprocessing new machine code file types for printing etc)!</p>
</div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body">The partial extension tree to merge with the full extension tree.</td>
</tr>
<tr class="field-even field"><th class="field-name">Return type:</th><td class="field-body">dict</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
<div class="section" id="octoprint-filemanager-preprocessor">
<span id="sec-plugins-hook-filemanager-preprocessor"></span><h3><a class="toc-backref" href="#id74">octoprint.filemanager.preprocessor</a><a class="headerlink" href="#octoprint-filemanager-preprocessor" title="Permalink to this headline">¶</a></h3>
<dl class="function">
<dt id="file_preprocessor_hook">
<code class="descname">file_preprocessor_hook</code><span class="sig-paren">(</span><em>path</em>, <em>file_object</em>, <em>links=None</em>, <em>printer_profile=None</em>, <em>allow_overwrite=False</em>, <em>*args</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#file_preprocessor_hook" title="Permalink to this definition">¶</a></dt>
<dd><p>Replace the <code class="docutils literal"><span class="pre">file_object</span></code> used for saving added files to storage by calling <a class="reference internal" href="../modules/filemanager.html#octoprint.filemanager.util.AbstractFileWrapper.save" title="octoprint.filemanager.util.AbstractFileWrapper.save"><code class="xref py py-func docutils literal"><span class="pre">save()</span></code></a>.</p>
<p><code class="docutils literal"><span class="pre">path</span></code> will be the future path of the file on the storage. The file’s name is accessible via
<code class="xref py py-attr docutils literal"><span class="pre">filename</span></code>.</p>
<p><code class="docutils literal"><span class="pre">file_object</span></code> will be a subclass of <a class="reference internal" href="../modules/filemanager.html#octoprint.filemanager.util.AbstractFileWrapper" title="octoprint.filemanager.util.AbstractFileWrapper"><code class="xref py py-class docutils literal"><span class="pre">AbstractFileWrapper</span></code></a>. Handlers may
access the raw data of the file via <a class="reference internal" href="../modules/filemanager.html#octoprint.filemanager.util.AbstractFileWrapper.stream" title="octoprint.filemanager.util.AbstractFileWrapper.stream"><code class="xref py py-func docutils literal"><span class="pre">stream()</span></code></a>, e.g.
to wrap it further. Handlers which do not wish to handle the <cite>file_object</cite> should just return it untouched.</p>
<p><strong>Example</strong></p>
<p>The following plugin example strips all comments from uploaded/generated GCODE files ending on the name postfix <code class="docutils literal"><span class="pre">_strip</span></code>.</p>
<div class="literal-block-wrapper docutils container" id="id17">
<div class="code-block-caption"><span class="caption-number">Listing 27 </span><span class="caption-text"><a class="reference external" href="https://github.com/OctoPrint/Plugin-Examples/blob/master/strip_all_comments.py">strip_all_comments.py</a></span><a class="headerlink" href="#id17" title="Permalink to this code">¶</a></div>
<div class="highlight-default"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># coding=utf-8</span>

<span class="kn">import</span> <span class="nn">octoprint.plugin</span>
<span class="kn">import</span> <span class="nn">octoprint.filemanager</span>
<span class="kn">import</span> <span class="nn">octoprint.filemanager.util</span>

<span class="kn">from</span> <span class="nn">octoprint.util.comm</span> <span class="kn">import</span> <span class="n">strip_comment</span>

<span class="k">class</span> <span class="nc">CommentStripper</span><span class="p">(</span><span class="n">octoprint</span><span class="o">.</span><span class="n">filemanager</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">LineProcessorStream</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">process_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">strip_comment</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">line</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span>

<span class="k">def</span> <span class="nf">strip_all_comments</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">file_object</span><span class="p">,</span> <span class="n">links</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">printer_profile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allow_overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">octoprint</span><span class="o">.</span><span class="n">filemanager</span><span class="o">.</span><span class="n">valid_file_type</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;gcode&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">file_object</span>

    <span class="kn">import</span> <span class="nn">os</span>
    <span class="n">name</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_object</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_strip&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">file_object</span>

    <span class="k">return</span> <span class="n">octoprint</span><span class="o">.</span><span class="n">filemanager</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">StreamWrapper</span><span class="p">(</span><span class="n">file_object</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">CommentStripper</span><span class="p">(</span><span class="n">file_object</span><span class="o">.</span><span class="n">stream</span><span class="p">()))</span>

<span class="n">__plugin_name__</span> <span class="o">=</span> <span class="s2">&quot;Strip comments from GCODE&quot;</span>
<span class="n">__plugin_description__</span> <span class="o">=</span> <span class="s2">&quot;Strips all comments and empty lines from uploaded/generated GCODE files ending on the name &quot;</span> \
                         <span class="s2">&quot;postfix </span><span class="se">\&quot;</span><span class="s2">_strip</span><span class="se">\&quot;</span><span class="s2">, e.g. </span><span class="se">\&quot;</span><span class="s2">some_file_strip.gcode</span><span class="se">\&quot;</span><span class="s2">.&quot;</span>
<span class="n">__plugin_pythoncompat__</span> <span class="o">=</span> <span class="s2">&quot;&gt;=2.7,&lt;4&quot;</span>
<span class="n">__plugin_hooks__</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;octoprint.filemanager.preprocessor&quot;</span><span class="p">:</span> <span class="n">strip_all_comments</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>path</strong> (<em>str</em>) – The path on storage the <cite>file_object</cite> is to be stored</li>
<li><strong>file_object</strong> (<a class="reference internal" href="../modules/filemanager.html#octoprint.filemanager.util.AbstractFileWrapper" title="octoprint.filemanager.util.AbstractFileWrapper"><em>AbstractFileWrapper</em></a>) – The <a class="reference internal" href="../modules/filemanager.html#octoprint.filemanager.util.AbstractFileWrapper" title="octoprint.filemanager.util.AbstractFileWrapper"><code class="xref py py-class docutils literal"><span class="pre">AbstractFileWrapper</span></code></a> instance
representing the file object to store.</li>
<li><strong>links</strong> (<em>dict</em>) – The links that are going to be stored with the file.</li>
<li><strong>printer_profile</strong> (<em>dict</em>) – The printer profile associated with the file.</li>
<li><strong>allow_overwrite</strong> (<em>boolean</em>) – Whether to allow overwriting an existing file named the same or not.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first">The <cite>file_object</cite> as passed in or None, or a replaced version to use instead for further processing.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Return type:</th><td class="field-body"><p class="first last"><a class="reference internal" href="../modules/filemanager.html#octoprint.filemanager.util.AbstractFileWrapper" title="octoprint.filemanager.util.AbstractFileWrapper">AbstractFileWrapper</a> or None</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
<div class="section" id="octoprint-printer-factory">
<span id="sec-plugins-hook-printer-factory"></span><h3><a class="toc-backref" href="#id75">octoprint.printer.factory</a><a class="headerlink" href="#octoprint-printer-factory" title="Permalink to this headline">¶</a></h3>
<dl class="function">
<dt id="printer_factory_hook">
<code class="descname">printer_factory_hook</code><span class="sig-paren">(</span><em>components</em>, <em>*args</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#printer_factory_hook" title="Permalink to this definition">¶</a></dt>
<dd><p>Return a <code class="xref py py-class docutils literal"><span class="pre">PrinterInstance</span></code> instance to use as global printer object. This will
be called only once during initial server startup.</p>
<p>The provided <code class="docutils literal"><span class="pre">components</span></code> is a dictionary containing the already initialized system components:</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal"><span class="pre">plugin_manager</span></code>: The <a class="reference internal" href="../modules/plugin.html#octoprint.plugin.core.PluginManager" title="octoprint.plugin.core.PluginManager"><code class="xref py py-class docutils literal"><span class="pre">PluginManager</span></code></a></li>
<li><code class="docutils literal"><span class="pre">printer_profile_manager</span></code>: The <a class="reference internal" href="../modules/printer.html#octoprint.printer.profile.PrinterProfileManager" title="octoprint.printer.profile.PrinterProfileManager"><code class="xref py py-class docutils literal"><span class="pre">PrinterProfileManager</span></code></a></li>
<li><code class="docutils literal"><span class="pre">event_bus</span></code>: The <code class="xref py py-class docutils literal"><span class="pre">EventManager</span></code></li>
<li><code class="docutils literal"><span class="pre">analysis_queue</span></code>: The <a class="reference internal" href="../modules/filemanager.html#octoprint.filemanager.analysis.AnalysisQueue" title="octoprint.filemanager.analysis.AnalysisQueue"><code class="xref py py-class docutils literal"><span class="pre">AnalysisQueue</span></code></a></li>
<li><code class="docutils literal"><span class="pre">slicing_manager</span></code>: The <a class="reference internal" href="../modules/slicing.html#octoprint.slicing.SlicingManager" title="octoprint.slicing.SlicingManager"><code class="xref py py-class docutils literal"><span class="pre">SlicingManager</span></code></a></li>
<li><code class="docutils literal"><span class="pre">file_manager</span></code>: The <code class="xref py py-class docutils literal"><span class="pre">FileManager</span></code></li>
<li><code class="docutils literal"><span class="pre">app_session_manager</span></code>: The <code class="xref py py-class docutils literal"><span class="pre">AppSessionManager</span></code></li>
<li><code class="docutils literal"><span class="pre">plugin_lifecycle_manager</span></code>: The <code class="xref py py-class docutils literal"><span class="pre">LifecycleManager</span></code></li>
<li><code class="docutils literal"><span class="pre">user_manager</span></code>: The <code class="xref py py-class docutils literal"><span class="pre">UserManager</span></code></li>
<li><code class="docutils literal"><span class="pre">preemptive_cache</span></code>: The <code class="xref py py-class docutils literal"><span class="pre">PreemptiveCache</span></code></li>
</ul>
</div></blockquote>
<p>If the factory returns anything but <code class="docutils literal"><span class="pre">None</span></code>, it will be assigned to the global <code class="docutils literal"><span class="pre">printer</span></code> instance.</p>
<p>If none of the registered factories return a printer instance, the default <code class="xref py py-class docutils literal"><span class="pre">Printer</span></code>
class will be instantiated.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>components</strong> (<em>dict</em>) – System components to use for printer instance initialization</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body">The <code class="docutils literal"><span class="pre">printer</span></code> instance to use globally.</td>
</tr>
<tr class="field-odd field"><th class="field-name">Return type:</th><td class="field-body">PrinterInterface subclass or None</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
<div class="section" id="octoprint-printer-estimation-factory">
<span id="sec-plugins-hook-printer-estimation-factory"></span><h3><a class="toc-backref" href="#id76">octoprint.printer.estimation.factory</a><a class="headerlink" href="#octoprint-printer-estimation-factory" title="Permalink to this headline">¶</a></h3>
<dl class="function">
<dt id="print_time_estimator_factory">
<code class="descname">print_time_estimator_factory</code><span class="sig-paren">(</span><em>*args</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#print_time_estimator_factory" title="Permalink to this definition">¶</a></dt>
<dd><p>Return a <code class="xref py py-class docutils literal"><span class="pre">PrintTimeEstimator</span></code> subclass (or factory) to use for print time
estimation. This will be called on each start of a print or streaming job with a single parameter <code class="docutils literal"><span class="pre">job_type</span></code>
denoting the type of job that was just started: <code class="docutils literal"><span class="pre">local</span></code> meaning a print of a local file through the serial connection,
<code class="docutils literal"><span class="pre">sdcard</span></code> a print of a file stored on the printer’s SD card, <code class="docutils literal"><span class="pre">stream</span></code> the streaming of a local file to the
printer’s SD card.</p>
<p>This is useful for plugins wishing to provide alternative methods of live print time estimation.</p>
<p>If none of the registered factories return a <code class="docutils literal"><span class="pre">PrintTimeEstimator</span></code> subclass, the default <code class="xref py py-class docutils literal"><span class="pre">PrintTimeEstimator</span></code>
will be used.</p>
<p><strong>Example:</strong></p>
<p>The following example would replace the stock print time estimator with (a nonsensical) one that always estimates
two hours of print time left:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">octoprint.printer.estimation</span> <span class="kn">import</span> <span class="n">PrintTimeEstimator</span>

<span class="k">class</span> <span class="nc">CustomPrintTimeEstimator</span><span class="p">(</span><span class="n">PrintTimeEstimator</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_type</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">estimate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">progress</span><span class="p">,</span> <span class="n">printTime</span><span class="p">,</span> <span class="n">cleanedPrintTime</span><span class="p">,</span> <span class="n">statisticalTotalPrintTime</span><span class="p">,</span> <span class="n">statisticalTotalPrintTimeType</span><span class="p">):</span>
        <span class="c1"># always reports 2h as printTimeLeft</span>
        <span class="k">return</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">,</span> <span class="s2">&quot;estimate&quot;</span>

<span class="k">def</span> <span class="nf">create_estimator_factory</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">CustomPrintTimeEstimator</span>

<span class="n">__plugin_hooks__</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s2">&quot;octoprint.printer.estimation.factory&quot;</span><span class="p">:</span> <span class="n">create_estimator_factory</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body">The <code class="xref py py-class docutils literal"><span class="pre">PrintTimeEstimator</span></code> class to use, or a factory method</td>
</tr>
<tr class="field-even field"><th class="field-name">Return type:</th><td class="field-body">class or function</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
<div class="section" id="octoprint-printer-sdcardupload">
<span id="sec-plugins-hook-octoprint-printer-sdcardupload"></span><h3><a class="toc-backref" href="#id77">octoprint.printer.sdcardupload</a><a class="headerlink" href="#octoprint-printer-sdcardupload" title="Permalink to this headline">¶</a></h3>
<dl class="function">
<dt id="sd_card_upload_hook">
<code class="descname">sd_card_upload_hook</code><span class="sig-paren">(</span><em>printer</em>, <em>filename</em>, <em>path</em>, <em>start_callback</em>, <em>success_callback</em>, <em>failure_callback</em>, <em>*args</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#sd_card_upload_hook" title="Permalink to this definition">¶</a></dt>
<dd><p>Via this hook plugins can change the way files are being uploaded to the sd card of the printer.</p>
<p>Implementations <strong>must</strong> call the provided <code class="docutils literal"><span class="pre">start_callback</span></code> on start of the file transfer and either the <code class="docutils literal"><span class="pre">success_callback</span></code>
or <code class="docutils literal"><span class="pre">failure_callback</span></code> on the end of the file transfer, depending on whether it was successful or not.</p>
<p>The <code class="docutils literal"><span class="pre">start_callback</span></code> has the following signature:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">start_callback</span><span class="p">(</span><span class="n">local_filename</span><span class="p">,</span> <span class="n">remote_filename</span><span class="p">):</span>
    <span class="c1"># ...</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">local_filename</span></code> must be the name of the file on the <code class="docutils literal"><span class="pre">local</span></code> storage, <code class="docutils literal"><span class="pre">remote_filename</span></code> the name of the file
to be created on the <code class="docutils literal"><span class="pre">sdcard</span></code> storage.</p>
<p><code class="docutils literal"><span class="pre">success_callback</span></code> and <code class="docutils literal"><span class="pre">failure_callback</span></code> both have the following signature:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">success_or_failure_callback</span><span class="p">(</span><span class="n">local_filename</span><span class="p">,</span> <span class="n">remote_filename</span><span class="p">,</span> <span class="n">elapsed</span><span class="p">):</span>
    <span class="c1"># ...</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">local_filename</span></code> must be the name of the file on the <code class="docutils literal"><span class="pre">local</span></code> storage, <code class="docutils literal"><span class="pre">remote_filename</span></code> the name of the file
to be created on the <code class="docutils literal"><span class="pre">sdcard</span></code> storage. <code class="docutils literal"><span class="pre">elapsed</span></code> is the elapsed time in seconds.</p>
<p>If the hook is going to handle the upload, it must return the (future) remote filename of the file on the <code class="docutils literal"><span class="pre">sdcard</span></code>
storage. If it returns <code class="docutils literal"><span class="pre">None</span></code> (or an otherwise falsy value), OctoPrint will interpret this as the hook not going to
handle the file upload, in which case the next hook or - if no other hook is registered - the default implementation
will be called.</p>
<p><strong>Example</strong></p>
<p>The following example creates a dummy SD card uploader that does nothing but sleep for ten seconds when a file
is supposed to be uploaded. Note that the long running process of sleeping for ten seconds is extracted into its
own thread, which is important in order to not block the main application!</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">def</span> <span class="nf">nop_upload_to_sd</span><span class="p">(</span><span class="n">printer</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">sd_upload_started</span><span class="p">,</span> <span class="n">sd_upload_succeeded</span><span class="p">,</span> <span class="n">sd_upload_failed</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="n">remote_name</span> <span class="o">=</span> <span class="n">printer</span><span class="o">.</span><span class="n">_get_free_remote_name</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting dummy SDCard upload from </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">remote_name</span><span class="p">))</span>

    <span class="n">sd_upload_started</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">remote_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">process</span><span class="p">():</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Sleeping 10s...&quot;</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;And done!&quot;</span><span class="p">)</span>
        <span class="n">sd_upload_succeeded</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">remote_name</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

    <span class="n">thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">process</span><span class="p">)</span>
    <span class="n">thread</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">remote_name</span>

<span class="n">__plugin_name__</span> <span class="o">=</span> <span class="s2">&quot;No-op SDCard Upload Test&quot;</span>
<span class="n">__plugin_hooks__</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;octoprint.printer.sdcardupload&quot;</span><span class="p">:</span> <span class="n">nop_upload_to_sd</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.3.11.</span></p>
</div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>printer</strong> (<em>object</em>) – the <a class="reference internal" href="../modules/printer.html#octoprint.printer.PrinterInterface" title="octoprint.printer.PrinterInterface"><code class="xref py py-class docutils literal"><span class="pre">PrinterInterface</span></code></a> instance the hook was called from</li>
<li><strong>filename</strong> (<em>str</em>) – filename on the <code class="docutils literal"><span class="pre">local</span></code> storage</li>
<li><strong>path</strong> (<em>str</em>) – path of the file in the local file system</li>
<li><strong>sd_upload_started</strong> (<em>function</em>) – callback for when the upload started</li>
<li><strong>sd_upload_success</strong> (<em>function</em>) – callback for successful finish of upload</li>
<li><strong>sd_upload_failure</strong> (<em>function</em>) – callback for failure of upload</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first">the name of the file on the <code class="docutils literal"><span class="pre">sdcard</span></code> storage or <code class="docutils literal"><span class="pre">None</span></code></p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Return type:</th><td class="field-body"><p class="first last">string or <code class="docutils literal"><span class="pre">None</span></code></p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
<div class="section" id="octoprint-server-api-after-request">
<span id="sec-plugins-hook-server-http-after-request"></span><h3><a class="toc-backref" href="#id78">octoprint.server.api.after_request</a><a class="headerlink" href="#octoprint-server-api-after-request" title="Permalink to this headline">¶</a></h3>
<dl class="function">
<dt id="after_request_handlers_hook">
<code class="descname">after_request_handlers_hook</code><span class="sig-paren">(</span><em>*args</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#after_request_handlers_hook" title="Permalink to this definition">¶</a></dt>
<dd><p>Allows adding additional after-request-handlers to API endpoints defined by OctoPrint itself and installed plugins.</p>
<p>Your plugin might need this to further restrict access to API methods. See the bundled “Force Login” plugin for a
usage example.</p>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">Implementing this hook will make your plugin require a restart of OctoPrint for enabling/disabling it fully.</p>
</div>
</dd></dl>

</div>
<div class="section" id="octoprint-server-api-before-request">
<span id="sec-plugins-hook-server-http-before-request"></span><h3><a class="toc-backref" href="#id79">octoprint.server.api.before_request</a><a class="headerlink" href="#octoprint-server-api-before-request" title="Permalink to this headline">¶</a></h3>
<dl class="function">
<dt>
<code class="descname">after_request_handlers_hook</code><span class="sig-paren">(</span><em>*args</em>, <em>**kwargs</em><span class="sig-paren">)</span></dt>
<dd><p>Allows adding additional before-request-handlers to API endpoints defined by OctoPrint itself and installed plugins.</p>
<p>Your plugin might need this to further restrict access to API methods. See the bundled “Force Login” plugin for a
usage example.</p>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">Implementing this hook will make your plugin require a restart of OctoPrint for enabling/disabling it fully.</p>
</div>
</dd></dl>

</div>
<div class="section" id="octoprint-server-http-access-validator">
<span id="sec-plugins-hook-server-http-access-validator"></span><h3><a class="toc-backref" href="#id80">octoprint.server.http.access_validator</a><a class="headerlink" href="#octoprint-server-http-access-validator" title="Permalink to this headline">¶</a></h3>
<dl class="function">
<dt id="access_validator_hook">
<code class="descname">access_validator_hook</code><span class="sig-paren">(</span><em>request</em>, <em>*args</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#access_validator_hook" title="Permalink to this definition">¶</a></dt>
<dd><p>Allows adding additional access validators to the default tornado routers.</p>
<p>Your plugin might need to this to restrict acccess to downloads and webcam snapshots further. See the bundled
“Force Login” plugin for a usage example.</p>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">Implementing this hook will make your plugin require a restart of OctoPrint for enabling/disabling it fully.</p>
</div>
</dd></dl>

</div>
<div class="section" id="octoprint-server-http-bodysize">
<span id="sec-plugins-hook-server-http-bodysize"></span><h3><a class="toc-backref" href="#id81">octoprint.server.http.bodysize</a><a class="headerlink" href="#octoprint-server-http-bodysize" title="Permalink to this headline">¶</a></h3>
<dl class="function">
<dt id="server_bodysize_hook">
<code class="descname">server_bodysize_hook</code><span class="sig-paren">(</span><em>current_max_body_sizes</em>, <em>*args</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#server_bodysize_hook" title="Permalink to this definition">¶</a></dt>
<dd><p>Allows extending the list of custom maximum body sizes on the web server per path and HTTP method with custom entries
from plugins.</p>
<p>Your plugin might need this if you want to allow uploading files larger than 100KB (the default maximum upload size
for anything but the <code class="docutils literal"><span class="pre">/api/files</span></code> endpoint).</p>
<p><code class="docutils literal"><span class="pre">current_max_body_sizes</span></code> will be a (read-only) list of the currently configured maximum body sizes, in case you
want to check from your plugin if you need to even add a new entry.</p>
<p>The hook must return a list of 3-tuples (the list’s length can be 0). Each 3-tuple should have the HTTP method
against which to match as first, a regular expression for the path to match against and the maximum body size as
an integer as the third entry.</p>
<p>The path of the route will be prefixed by OctoPrint with <code class="docutils literal"><span class="pre">/plugin/&lt;plugin</span> <span class="pre">identifier&gt;/</span></code> (if the path already begins
with a <code class="docutils literal"><span class="pre">/</span></code> that will be stripped first).</p>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">Implementing this hook will make your plugin require a restart of OctoPrint for enabling/disabling it fully.</p>
</div>
<p><strong>Example</strong></p>
<p>The following plugin example sets the maximum body size for <code class="docutils literal"><span class="pre">POST</span></code> requests against four custom URLs to 100, 200,
500 and 1024KB. To test its functionality try uploading files larger or smaller than an endpoint’s configured maximum
size (as multipart request with the file upload residing in request parameter <code class="docutils literal"><span class="pre">file</span></code>) and observe the behaviour.</p>
<div class="literal-block-wrapper docutils container" id="id18">
<div class="code-block-caption"><span class="caption-number">Listing 28 </span><span class="caption-text"><a class="reference external" href="https://github.com/OctoPrint/Plugin-Examples/blob/master/increase_bodysize.py">increase_bodysize.py</a></span><a class="headerlink" href="#id18" title="Permalink to this code">¶</a></div>
<div class="highlight-default"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># coding=utf-8</span>

<span class="kn">import</span> <span class="nn">octoprint.plugin</span>
<span class="kn">import</span> <span class="nn">flask</span>

<span class="k">class</span> <span class="nc">BodySizePlugin</span><span class="p">(</span><span class="n">octoprint</span><span class="o">.</span><span class="n">plugin</span><span class="o">.</span><span class="n">BlueprintPlugin</span><span class="p">,</span>
                     <span class="n">octoprint</span><span class="o">.</span><span class="n">plugin</span><span class="o">.</span><span class="n">SettingsPlugin</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sizes</span> <span class="o">=</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>

    <span class="nd">@octoprint</span><span class="o">.</span><span class="n">plugin</span><span class="o">.</span><span class="n">BlueprintPlugin</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/upload/&lt;int:size&gt;&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">api_endpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">size</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sizes</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">flask</span><span class="o">.</span><span class="n">make_response</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>

        <span class="n">input_name</span> <span class="o">=</span> <span class="s2">&quot;file&quot;</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">,</span> <span class="s2">&quot;content_type&quot;</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">found_file</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">param</span> <span class="o">=</span> <span class="n">input_name</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">key</span>
            <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="s2">&quot;found_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">param</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">flask</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">bodysize_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_max_body_sizes</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[(</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;/upload/</span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">size</span><span class="p">,</span> <span class="n">size</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span> <span class="k">for</span> <span class="n">size</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sizes</span><span class="p">]</span>

<span class="n">__plugin_name__</span> <span class="o">=</span> <span class="s2">&quot;Increase upload size&quot;</span>
<span class="n">__plugin_description__</span> <span class="o">=</span> <span class="s2">&quot;Increases the body size on some custom API endpoints&quot;</span>
<span class="n">__plugin_pythoncompat__</span> <span class="o">=</span> <span class="s2">&quot;&gt;=2.7,&lt;4&quot;</span>

<span class="k">def</span> <span class="nf">__plugin_load__</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">__plugin_implementation__</span>
    <span class="k">global</span> <span class="n">__plugin_hooks__</span>

    <span class="n">__plugin_implementation__</span> <span class="o">=</span> <span class="n">BodySizePlugin</span><span class="p">()</span>
    <span class="n">__plugin_hooks__</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;octoprint.server.http.bodysize&quot;</span><span class="p">:</span> <span class="n">__plugin_implementation__</span><span class="o">.</span><span class="n">bodysize_hook</span>
    <span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>current_max_body_sizes</strong> (<em>list</em>) – read-only list of the currently configured maximum body sizes</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body">A list of 3-tuples with additional request specific maximum body sizes as defined above</td>
</tr>
<tr class="field-odd field"><th class="field-name">Return type:</th><td class="field-body">list</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
<div class="section" id="octoprint-server-http-routes">
<span id="sec-plugins-hook-server-http-routes"></span><h3><a class="toc-backref" href="#id82">octoprint.server.http.routes</a><a class="headerlink" href="#octoprint-server-http-routes" title="Permalink to this headline">¶</a></h3>
<dl class="function">
<dt id="server_route_hook">
<code class="descname">server_route_hook</code><span class="sig-paren">(</span><em>server_routes</em>, <em>*args</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#server_route_hook" title="Permalink to this definition">¶</a></dt>
<dd><p>Allows extending the list of routes registered on the web server.</p>
<p>This is interesting for plugins which want to provide their own download URLs which will then be delivered statically
following the same path structure as regular downloads.</p>
<p><code class="docutils literal"><span class="pre">server_routes</span></code> will be a (read-only) list of the currently defined server routes, in case you want to check from
your plugin against that.</p>
<p>The hook must return a list of 3-tuples (the list’s length can be 0). Each 3-tuple should have the path of the route
(a string defining its regular expression) as the first, the <a class="reference external" href="http://tornado.readthedocs.org/en/branch4.0/web.html#request-handlers">RequestHandler</a>
class to use for the route as the second and a dictionary with keywords parameters for the defined request handler as
the third entry.</p>
<p>The path of the route will be prefixed by OctoPrint with <code class="docutils literal"><span class="pre">/plugin/&lt;plugin</span> <span class="pre">identifier&gt;/</span></code> (if the path already begins
with a <code class="docutils literal"><span class="pre">/</span></code> that will be stripped first).</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Static routes provided through this hook take precedence over routes defined through blueprints.</p>
<p class="last">If your plugin also implements the <a class="reference internal" href="mixins.html#octoprint.plugin.BlueprintPlugin" title="octoprint.plugin.BlueprintPlugin"><code class="xref py py-class docutils literal"><span class="pre">BlueprintPlugin</span></code></a> mixin and has defined a route for a
view on that which matches one of the paths provided via its <code class="docutils literal"><span class="pre">octoprint.server.http.routes</span></code> hook handler, the
view of the blueprint will thus not be reachable since processing of the request will directly be handed over
to your defined handler class.</p>
</div>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">If you want your route to support CORS if it’s enabled in OctoPrint, your <a class="reference external" href="http://tornado.readthedocs.org/en/branch4.0/web.html#request-handlers">RequestHandler</a>
needs to implement the <a class="reference internal" href="../modules/server.html#octoprint.server.util.tornado.CorsSupportMixin" title="octoprint.server.util.tornado.CorsSupportMixin"><code class="xref py py-class docutils literal"><span class="pre">CorsSupportMixin</span></code></a> for this to work. Note that all of
<a class="reference internal" href="../modules/server.html#octoprint.server.util.tornado.LargeResponseHandler" title="octoprint.server.util.tornado.LargeResponseHandler"><code class="xref py py-class docutils literal"><span class="pre">LargeResponseHandler</span></code></a>, <a class="reference internal" href="../modules/server.html#octoprint.server.util.tornado.UrlProxyHandler" title="octoprint.server.util.tornado.UrlProxyHandler"><code class="xref py py-class docutils literal"><span class="pre">UrlProxyHandler</span></code></a>,
<a class="reference internal" href="../modules/server.html#octoprint.server.util.tornado.StaticDataHandler" title="octoprint.server.util.tornado.StaticDataHandler"><code class="xref py py-class docutils literal"><span class="pre">StaticDataHandler</span></code></a> and <a class="reference internal" href="../modules/server.html#octoprint.server.util.tornado.DeprecatedEndpointHandler" title="octoprint.server.util.tornado.DeprecatedEndpointHandler"><code class="xref py py-class docutils literal"><span class="pre">DeprecatedEndpointHandler</span></code></a>
already implement this mixin.</p>
</div>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">Implementing this hook will make your plugin require a restart of OctoPrint for enabling/disabling it fully.</p>
</div>
<p><strong>Example</strong></p>
<p>The following example registers two new routes <code class="docutils literal"><span class="pre">/plugin/add_tornado_route/download</span></code> and <code class="docutils literal"><span class="pre">/plugin/add_tornado_route/forward</span></code>
in the webserver which roughly replicate the functionality of <code class="docutils literal"><span class="pre">/downloads/files/local</span></code> and <code class="docutils literal"><span class="pre">/downloads/camera/current</span></code>.</p>
<div class="literal-block-wrapper docutils container" id="id19">
<div class="code-block-caption"><span class="caption-number">Listing 29 </span><span class="caption-text"><a class="reference external" href="https://github.com/OctoPrint/Plugin-Examples/blob/master/add_tornado_route.py">add_tornado_route.py</a></span><a class="headerlink" href="#id19" title="Permalink to this code">¶</a></div>
<div class="highlight-default"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># coding=utf-8</span>

<span class="kn">import</span> <span class="nn">octoprint.plugin</span>

<span class="k">class</span> <span class="nc">TornadoRoutePlugin</span><span class="p">(</span><span class="n">octoprint</span><span class="o">.</span><span class="n">plugin</span><span class="o">.</span><span class="n">SettingsPlugin</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">route_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server_routes</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">octoprint.server.util.tornado</span> <span class="kn">import</span> <span class="n">LargeResponseHandler</span><span class="p">,</span> <span class="n">UrlProxyHandler</span><span class="p">,</span> <span class="n">path_validation_factory</span>
        <span class="kn">from</span> <span class="nn">octoprint.util</span> <span class="kn">import</span> <span class="n">is_hidden_path</span>

        <span class="k">return</span> <span class="p">[</span>
            <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;/download/(.*)&quot;</span><span class="p">,</span> <span class="n">LargeResponseHandler</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="o">.</span><span class="n">global_get_basefolder</span><span class="p">(</span><span class="s2">&quot;uploads&quot;</span><span class="p">),</span>
                                                           <span class="n">as_attachment</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                           <span class="n">path_validation</span><span class="o">=</span><span class="n">path_validation_factory</span><span class="p">(</span><span class="k">lambda</span> <span class="n">path</span><span class="p">:</span> <span class="ow">not</span> <span class="n">is_hidden_path</span><span class="p">(</span><span class="n">path</span><span class="p">),</span>
                                                                                                   <span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">))),</span>
            <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;forward&quot;</span><span class="p">,</span> <span class="n">UrlProxyHandler</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="o">.</span><span class="n">global_get</span><span class="p">([</span><span class="s2">&quot;webcam&quot;</span><span class="p">,</span> <span class="s2">&quot;snapshot&quot;</span><span class="p">]),</span>
                                                    <span class="n">as_attachment</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="p">]</span>

<span class="n">__plugin_name__</span> <span class="o">=</span> <span class="s2">&quot;Add Tornado Route&quot;</span>
<span class="n">__plugin_description__</span> <span class="o">=</span> <span class="s2">&quot;Adds two tornado routes to demonstrate hook usage&quot;</span>
<span class="n">__plugin_pythoncompat__</span> <span class="o">=</span> <span class="s2">&quot;&gt;=2.7,&lt;4&quot;</span>

<span class="k">def</span> <span class="nf">__plugin_load__</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">__plugin_implementation__</span>
    <span class="k">global</span> <span class="n">__plugin_hooks__</span>

    <span class="n">__plugin_implementation__</span> <span class="o">=</span> <span class="n">TornadoRoutePlugin</span><span class="p">()</span>
    <span class="n">__plugin_hooks__</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;octoprint.server.http.routes&quot;</span><span class="p">:</span> <span class="n">__plugin_implementation__</span><span class="o">.</span><span class="n">route_hook</span>
    <span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="../modules/server.html#octoprint.server.util.tornado.LargeResponseHandler" title="octoprint.server.util.tornado.LargeResponseHandler"><code class="xref py py-class docutils literal"><span class="pre">LargeResponseHandler</span></code></a></dt>
<dd>Customized <a class="reference external" href="http://tornado.readthedocs.org/en/branch4.0/web.html#tornado.web.StaticFileHandler">tornado.web.StaticFileHandler</a>
that allows delivery of the requested resource as attachment and access validation through an optional callback.</dd>
<dt><code class="xref py py-class docutils literal"><span class="pre">UrlForwardHandler</span></code></dt>
<dd><a class="reference external" href="http://tornado.readthedocs.org/en/branch4.0/web.html#request-handlers">tornado.web.RequestHandler</a> that proxies
requests to a preconfigured URL and returns the response.</dd>
</dl>
</div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>server_routes</strong> (<em>list</em>) – read-only list of the currently configured server routes</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body">a list of 3-tuples with additional routes as defined above</td>
</tr>
<tr class="field-odd field"><th class="field-name">Return type:</th><td class="field-body">list</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
<div class="section" id="octoprint-server-sockjs-authed">
<span id="sec-plugins-hook-server-sockjs-authed"></span><h3><a class="toc-backref" href="#id83">octoprint.server.sockjs.authed</a><a class="headerlink" href="#octoprint-server-sockjs-authed" title="Permalink to this headline">¶</a></h3>
<dl class="function">
<dt>
<code class="descname">socket_authed_hook(socket, user, *args, **kwargs):</code></dt>
<dd><p>Allows plugins to be notified that a user got authenticated or deauthenticated on the socket (e.g. due to logout).</p>
<p>See the bundled <a class="reference internal" href="../bundledplugins/forcelogin.html#sec-bundledplugins-forcelogin"><span class="std std-ref">Forcelogin Plugin</span></a> for an example on how to utilize this.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>socket</strong> (<em>object</em>) – the socket object which is about to be registered</li>
<li><strong>user</strong> (<em>object</em>) – the user that got authenticated on the socket, or None if the user got deauthenticated</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
<div class="section" id="octoprint-server-sockjs-register">
<span id="sec-plugins-hook-server-sockjs-register"></span><h3><a class="toc-backref" href="#id84">octoprint.server.sockjs.register</a><a class="headerlink" href="#octoprint-server-sockjs-register" title="Permalink to this headline">¶</a></h3>
<dl class="function">
<dt>
<code class="descname">socket_registration_hook(socket, user, *args, **kwargs):</code></dt>
<dd><p>Allows plugins to prevent a new <a class="reference internal" href="../api/push.html#sec-api-push"><span class="std std-ref">push socket client</span></a> to be registered to the system.</p>
<p>Handlers should return either <code class="docutils literal"><span class="pre">True</span></code> or <code class="docutils literal"><span class="pre">False</span></code>. <code class="docutils literal"><span class="pre">True</span></code> signals to proceed with normal registration. <code class="docutils literal"><span class="pre">False</span></code>
signals to not register the client.</p>
<p>See the bundled <a class="reference internal" href="../bundledplugins/forcelogin.html#sec-bundledplugins-forcelogin"><span class="std std-ref">Forcelogin Plugin</span></a> for an example on how to utilize this.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>socket</strong> (<em>object</em>) – the socket object which is about to be registered</li>
<li><strong>user</strong> (<em>object</em>) – the user currently authenticated on the socket - might be None</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first">whether to proceed with registration (<code class="docutils literal"><span class="pre">True</span></code>) or not (<code class="docutils literal"><span class="pre">False</span></code>)</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Return type:</th><td class="field-body"><p class="first last">boolean</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
<div class="section" id="octoprint-server-sockjs-emit">
<span id="sec-plugins-hook-server-sockjs-emit"></span><h3><a class="toc-backref" href="#id85">octoprint.server.sockjs.emit</a><a class="headerlink" href="#octoprint-server-sockjs-emit" title="Permalink to this headline">¶</a></h3>
<dl class="function">
<dt>
<code class="descname">socket_emit_hook(socket, user, message, payload, *args, **kwargs):</code></dt>
<dd><p>Allows plugins to prevent any messages to be emitted on an existing <a class="reference internal" href="../api/push.html#sec-api-push"><span class="std std-ref">push connection</span></a>.</p>
<p>Handlers should return either <code class="docutils literal"><span class="pre">True</span></code> to allow the message to be emitted, or <code class="docutils literal"><span class="pre">False</span></code> to prevent it.</p>
<p>See the bundled <a class="reference internal" href="../bundledplugins/forcelogin.html#sec-bundledplugins-forcelogin"><span class="std std-ref">Forcelogin Plugin</span></a> for an example on how to utilize this.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>socket</strong> (<em>object</em>) – the socket object on which a message is about to be emitted</li>
<li><strong>user</strong> (<em>object</em>) – the user currently authenticated on the socket - might be None</li>
<li><strong>message</strong> (<em>string</em>) – the message type about to be emitted</li>
<li><strong>payload</strong> (<em>dict</em>) – the payload of the message about to be emitted (may be None)</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first">whether to proceed with sending the message (<code class="docutils literal"><span class="pre">True</span></code>) or not (<code class="docutils literal"><span class="pre">False</span></code>)</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Return type:</th><td class="field-body"><p class="first last">boolean</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
<div class="section" id="octoprint-timelapse-extensions">
<span id="sec-plugins-hook-timelapse-extensions"></span><h3><a class="toc-backref" href="#id86">octoprint.timelapse.extensions</a><a class="headerlink" href="#octoprint-timelapse-extensions" title="Permalink to this headline">¶</a></h3>
<dl class="function">
<dt id="timelapse_extension_hook">
<code class="descname">timelapse_extension_hook</code><span class="sig-paren">(</span><em>*args</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#timelapse_extension_hook" title="Permalink to this definition">¶</a></dt>
<dd><p>Allows extending the set of supported file extensions for timelapse files. Handlers must return a list of
additional file extensions.</p>
<p><strong>Example</strong></p>
<p>Allow the management of timelapse GIFs with extension <code class="docutils literal"><span class="pre">gif</span></code>.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_timelapse_extensions</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;gif&quot;</span><span class="p">]</span>

<span class="n">__plugin_hooks__</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;octoprint.timelapse.extensions&quot;</span><span class="p">:</span> <span class="n">get_timelapse_extensions</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body">a list of additional file extensions</td>
</tr>
<tr class="field-even field"><th class="field-name">Return type:</th><td class="field-body">list</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
<div class="section" id="octoprint-ui-web-templatetypes">
<span id="sec-plugins-hook-ui-web-templatetypes"></span><h3><a class="toc-backref" href="#id87">octoprint.ui.web.templatetypes</a><a class="headerlink" href="#octoprint-ui-web-templatetypes" title="Permalink to this headline">¶</a></h3>
<dl class="function">
<dt id="templatetype_hook">
<code class="descname">templatetype_hook</code><span class="sig-paren">(</span><em>template_sorting</em>, <em>template_rules</em>, <em>*args</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#templatetype_hook" title="Permalink to this definition">¶</a></dt>
<dd><p>Allows extending the set of supported template types in the web interface. This is interesting for plugins which want
to offer other plugins to hook into their own offered UIs. Handlers must return a list of additional template
specifications in form of 3-tuples.</p>
<p>The first entry of the tuple must be the name of the template type and will be automatically prefixed with
<code class="docutils literal"><span class="pre">plugin_&lt;identifier&gt;_</span></code>.</p>
<p>The second entry must be a sorting specification that defines how OctoPrint should sort multiple templates injected
through plugins of this template type. The sorting specification should be a dict with the following possible
entries:</p>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="5%" />
<col width="95%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><strong>Key</strong></td>
<td><strong>Description</strong></td>
</tr>
<tr class="row-even"><td>key</td>
<td>The sorting key within the template config to use for sorting the list of template injections. This may be
<code class="docutils literal"><span class="pre">None</span></code> in which case no sorting will be taking place. Defaults to <code class="docutils literal"><span class="pre">name</span></code>.</td>
</tr>
<tr class="row-odd"><td>add</td>
<td>Usually irrelevant for custom template types, only listed for the sake of completeness. The method of adding
the sorted list of template injections from plugins to the template injections from the
core. May be <code class="docutils literal"><span class="pre">append</span></code> to append the list, <code class="docutils literal"><span class="pre">prepend</span></code> to prepend the list, or <code class="docutils literal"><span class="pre">custom_append</span></code> or
<code class="docutils literal"><span class="pre">custom_prepend</span></code> to append respectively prepend but going so after preprocessing the entries and order data
with custom functions (e.g. to inject additional entries such as the “Plugins” section header in the settings
dialog). For custom template types this defaults to <code class="docutils literal"><span class="pre">append</span></code>.</td>
</tr>
<tr class="row-even"><td>custom_add_entries</td>
<td>Usually irrelevant for custom template types, only listed for the sake of completeness. Custom preprocessor
for the entries provided through plugins, before they are added to the general template entries
context variable for the current template type.</td>
</tr>
<tr class="row-odd"><td>custom_add_order</td>
<td>Usually irrelevant for custom template types, only listed for the sake of completeness. Custom preprocessor
for the template order provided through plugins, before they are added to the general template order
context variable for the current template type.</td>
</tr>
</tbody>
</table>
<p>The third entry must be a rule specification in form of a dict which tells OctoPrint how to process the template
configuration entries provided by <a class="reference internal" href="mixins.html#octoprint.plugin.TemplatePlugin.get_template_configs" title="octoprint.plugin.TemplatePlugin.get_template_configs"><code class="xref py py-func docutils literal"><span class="pre">get_template_configs()</span></code></a> by providing
transformation functions of various kinds:</p>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="5%" />
<col width="95%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><strong>Key</strong></td>
<td><strong>Description</strong></td>
</tr>
<tr class="row-even"><td>div</td>
<td>Function that returns the id of the container for template content if not explicitly provided by the template
config, input parameter is the name of the plugin providing the currently processed template config. If not
provided this defaults to a lambda function of the form <code class="docutils literal"><span class="pre">lambda</span> <span class="pre">x:</span> <span class="pre">&quot;&lt;plugin</span> <span class="pre">identifier&gt;_&lt;template</span> <span class="pre">type&gt;_plugin_&quot;</span> <span class="pre">+</span> <span class="pre">x</span></code>
with <code class="docutils literal"><span class="pre">plugin</span> <span class="pre">identifier</span></code> being the identifier of the plugin providing the additional template type.</td>
</tr>
<tr class="row-odd"><td>template</td>
<td>Function that returns the default template filename for a template type to attempt to include in case no
template name is explicitly provided by the template config, input parameter is the name of the plugin providing
the current processed template config. If not provided this defaults to a lambda function of the form
<code class="docutils literal"><span class="pre">lambda</span> <span class="pre">x:</span> <span class="pre">x</span> <span class="pre">+</span> <span class="pre">&quot;_plugin_&lt;plugin</span> <span class="pre">identifier&gt;_&lt;template</span> <span class="pre">type&gt;.jinja2&quot;</span></code> with <code class="docutils literal"><span class="pre">plugin</span> <span class="pre">identifier</span></code> being the
identifier of the plugin providing the additional template type.</td>
</tr>
<tr class="row-even"><td>to_entry</td>
<td>Function to transform a template config to the data structure stored in the Jinja context for the injected
template. If not provided this defaults to a lambda function returning a 2-tuple of the <code class="docutils literal"><span class="pre">name</span></code> value of
the template config and the template config itself (<code class="docutils literal"><span class="pre">lambda</span> <span class="pre">data:</span> <span class="pre">(data[&quot;name&quot;],</span> <span class="pre">data)</span></code>)</td>
</tr>
<tr class="row-odd"><td>mandatory</td>
<td>A list of keys that must be included in the template config for this template type. Template configs not containing
all of the keys in this list will be ignored. Defaults to an empty list.</td>
</tr>
</tbody>
</table>
<p>OctoPrint will provide all template configs for custom template types in the Jinja rendering context in the same way
as it provides the template configs for core template types, through the <code class="docutils literal"><span class="pre">templates</span></code> context variable which is a
dict mapping from the template type name (<code class="docutils literal"><span class="pre">plugin_&lt;plugin</span> <span class="pre">identifier&gt;_&lt;template</span> <span class="pre">type&gt;</span></code> for custom ones) to a dict
with <code class="docutils literal"><span class="pre">entries</span></code> and <code class="docutils literal"><span class="pre">order</span></code> values, the first containing a dict of all registered template configs, the latter
an ordered list of all registered template keys of the type in the order they should be rendered. Plugins should
iterate over the <code class="docutils literal"><span class="pre">order</span></code> list and then render each entry utilizing the template entry as provided for the key in
the <code class="docutils literal"><span class="pre">entries</span></code> dict (note that this entry will have the format specified through the <code class="docutils literal"><span class="pre">to_entry</span></code> section in the
template rule).</p>
<p><strong>Example</strong></p>
<p>The example consists of two plugins, one providing a custom template type and the other consuming it.</p>
<p>First the provider:</p>
<div class="literal-block-wrapper docutils container" id="id20">
<div class="code-block-caption"><span class="caption-number">Listing 30 </span><span class="caption-text"><a class="reference external" href="https://github.com/OctoPrint/Plugin-Examples/blob/master/custom_template_provider/__init__.py">custom_template_provider/__init__.py</a></span><a class="headerlink" href="#id20" title="Permalink to this code">¶</a></div>
<div class="highlight-default"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># coding=utf-8</span>

<span class="kn">import</span> <span class="nn">octoprint.plugin</span>

<span class="k">class</span> <span class="nc">CustomTemplateTypeProvider</span><span class="p">(</span><span class="n">octoprint</span><span class="o">.</span><span class="n">plugin</span><span class="o">.</span><span class="n">TemplatePlugin</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">add_templatetype</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_order</span><span class="p">,</span> <span class="n">current_rules</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;awesometemplate&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(),</span> <span class="nb">dict</span><span class="p">(</span><span class="n">template</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="s2">&quot;_awesometemplate.jinja2&quot;</span><span class="p">))</span>
        <span class="p">]</span>

<span class="n">__plugin_name__</span> <span class="o">=</span> <span class="s2">&quot;Custom Template Provider&quot;</span>
<span class="n">__plugin_pythoncompat__</span> <span class="o">=</span> <span class="s2">&quot;&gt;=2.7,&lt;4&quot;</span>
<span class="k">def</span> <span class="nf">__plugin_load__</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">__plugin_implementation__</span>
    <span class="n">__plugin_implementation__</span> <span class="o">=</span> <span class="n">CustomTemplateTypeProvider</span><span class="p">()</span>

    <span class="k">global</span> <span class="n">__plugin_hooks__</span>
    <span class="n">__plugin_hooks__</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;octoprint.ui.web.templatetypes&quot;</span><span class="p">:</span> <span class="n">__plugin_implementation__</span><span class="o">.</span><span class="n">add_templatetype</span>
    <span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="literal-block-wrapper docutils container" id="id21">
<div class="code-block-caption"><span class="caption-number">Listing 31 </span><span class="caption-text"><a class="reference external" href="https://github.com/OctoPrint/Plugin-Examples/blob/master/custom_template_provider/templates/custom_template_provider_settings.jinja2">custom_template_provider/templates/custom_template_provider_settings.jinja2</a></span><a class="headerlink" href="#id21" title="Permalink to this code">¶</a></div>
<div class="highlight-default"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">h3</span><span class="o">&gt;</span><span class="p">{{</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Awesome Template Injections&#39;</span><span class="p">)</span> <span class="p">}}</span><span class="o">&lt;/</span><span class="n">h3</span><span class="o">&gt;</span>

<span class="p">{</span><span class="o">%</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">templates</span><span class="o">.</span><span class="n">plugin_custom_template_provider_awesometemplate</span><span class="o">.</span><span class="n">order</span> <span class="o">%</span><span class="p">}</span>
    <span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">heading</span><span class="p">,</span> <span class="n">config</span> <span class="o">=</span> <span class="n">templates</span><span class="o">.</span><span class="n">plugin_custom_template_provider_awesometemplate</span><span class="o">.</span><span class="n">entries</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">%</span><span class="p">}</span>
    <span class="o">&lt;</span><span class="n">div</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;{{ config._div }}&quot;</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">h4</span><span class="o">&gt;</span><span class="p">{{</span> <span class="n">heading</span> <span class="p">}}</span><span class="o">&lt;/</span><span class="n">h4</span><span class="o">&gt;</span>
        <span class="p">{</span><span class="o">%</span> <span class="n">include</span> <span class="n">config</span><span class="o">.</span><span class="n">template</span> <span class="n">ignore</span> <span class="n">missing</span> <span class="o">%</span><span class="p">}</span>
    <span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
<span class="p">{</span><span class="o">%</span> <span class="n">endfor</span> <span class="o">%</span><span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<p>Then the consumer:</p>
<div class="literal-block-wrapper docutils container" id="id22">
<div class="code-block-caption"><span class="caption-number">Listing 32 </span><span class="caption-text"><a class="reference external" href="https://github.com/OctoPrint/Plugin-Examples/blob/master/custom_template_consumer/__init__.py">custom_template_consumer/__init__.py</a></span><a class="headerlink" href="#id22" title="Permalink to this code">¶</a></div>
<div class="highlight-default"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># coding=utf-8</span>

<span class="kn">import</span> <span class="nn">octoprint.plugin</span>

<span class="k">class</span> <span class="nc">CustomTemplateTypeConsumer</span><span class="p">(</span><span class="n">octoprint</span><span class="o">.</span><span class="n">plugin</span><span class="o">.</span><span class="n">TemplatePlugin</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get_template_configs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;custom_template_provider&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plugin_manager</span><span class="o">.</span><span class="n">enabled_plugins</span><span class="p">:</span>
            <span class="c1"># if our custom template provider is not registered, we&#39;ll act as a regular settings plugin</span>
            <span class="k">return</span> <span class="p">[</span>
                <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;settings&quot;</span><span class="p">,</span> <span class="n">template</span><span class="o">=</span><span class="s2">&quot;custom_template_consumer_awesometemplate.jinja2&quot;</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># else we&#39;ll inject ourselves as an awesometemplate type instead - since we named our jinja2 file</span>
            <span class="c1"># accordingly we don&#39;t have to explicitly define that here, it will be picked up automatically</span>
            <span class="k">return</span> <span class="p">[]</span>

<span class="n">__plugin_name__</span> <span class="o">=</span> <span class="s2">&quot;Custom Template Consumer&quot;</span>
<span class="n">__plugin_pythoncompat__</span> <span class="o">=</span> <span class="s2">&quot;&gt;=2.7,&lt;4&quot;</span>
<span class="n">__plugin_implementation__</span> <span class="o">=</span> <span class="n">CustomTemplateTypeConsumer</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="literal-block-wrapper docutils container" id="id23">
<div class="code-block-caption"><span class="caption-number">Listing 33 </span><span class="caption-text"><a class="reference external" href="https://github.com/OctoPrint/Plugin-Examples/blob/master/custom_template_consumer/templates/custom_template_consumer_awesometemplate.jinja2">custom_template_consumer/templates/custom_template_consumer_awesometemplate.jinja2</a></span><a class="headerlink" href="#id23" title="Permalink to this code">¶</a></div>
<div class="highlight-default"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="s2">&quot;Hello World!&quot;</span> <span class="kn">from</span> <span class="nn">an</span> <span class="n">injected</span> <span class="n">awesome</span> <span class="n">template</span><span class="o">.</span>
</pre></div>
</td></tr></table></div>
</div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>template_rules</strong> (<em>dict</em>) – read-only dictionary of currently configured template rules</li>
<li><strong>template_sorting</strong> (<em>dict</em>) – read-only dictionary of currently configured template sorting specifications</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first">a list of 3-tuples (template type, rule, sorting spec)</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Return type:</th><td class="field-body"><p class="first last">list</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
<div class="section" id="octoprint-users-factory">
<span id="sec-plugins-hook-users-factory"></span><h3><a class="toc-backref" href="#id88">octoprint.users.factory</a><a class="headerlink" href="#octoprint-users-factory" title="Permalink to this headline">¶</a></h3>
<dl class="function">
<dt id="user_manager_factory_hook">
<code class="descname">user_manager_factory_hook</code><span class="sig-paren">(</span><em>components</em>, <em>settings</em>, <em>*args</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#user_manager_factory_hook" title="Permalink to this definition">¶</a></dt>
<dd><p>Return a <code class="xref py py-class docutils literal"><span class="pre">UserManager</span></code> instance to use as global user manager object. This will
be called only once during initial server startup.</p>
<p>The provided <code class="docutils literal"><span class="pre">components</span></code> is a dictionary containing the already initialized system components:</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal"><span class="pre">plugin_manager</span></code>: The <a class="reference internal" href="../modules/plugin.html#octoprint.plugin.core.PluginManager" title="octoprint.plugin.core.PluginManager"><code class="xref py py-class docutils literal"><span class="pre">PluginManager</span></code></a></li>
<li><code class="docutils literal"><span class="pre">printer_profile_manager</span></code>: The <a class="reference internal" href="../modules/printer.html#octoprint.printer.profile.PrinterProfileManager" title="octoprint.printer.profile.PrinterProfileManager"><code class="xref py py-class docutils literal"><span class="pre">PrinterProfileManager</span></code></a></li>
<li><code class="docutils literal"><span class="pre">event_bus</span></code>: The <code class="xref py py-class docutils literal"><span class="pre">EventManager</span></code></li>
<li><code class="docutils literal"><span class="pre">analysis_queue</span></code>: The <a class="reference internal" href="../modules/filemanager.html#octoprint.filemanager.analysis.AnalysisQueue" title="octoprint.filemanager.analysis.AnalysisQueue"><code class="xref py py-class docutils literal"><span class="pre">AnalysisQueue</span></code></a></li>
<li><code class="docutils literal"><span class="pre">slicing_manager</span></code>: The <a class="reference internal" href="../modules/slicing.html#octoprint.slicing.SlicingManager" title="octoprint.slicing.SlicingManager"><code class="xref py py-class docutils literal"><span class="pre">SlicingManager</span></code></a></li>
<li><code class="docutils literal"><span class="pre">file_manager</span></code>: The <code class="xref py py-class docutils literal"><span class="pre">FileManager</span></code></li>
<li><code class="docutils literal"><span class="pre">app_session_manager</span></code>: The <code class="xref py py-class docutils literal"><span class="pre">AppSessionManager</span></code></li>
<li><code class="docutils literal"><span class="pre">plugin_lifecycle_manager</span></code>: The <code class="xref py py-class docutils literal"><span class="pre">LifecycleManager</span></code></li>
<li><code class="docutils literal"><span class="pre">preemptive_cache</span></code>: The <code class="xref py py-class docutils literal"><span class="pre">PreemptiveCache</span></code></li>
</ul>
</div></blockquote>
<p>If the factory returns anything but <code class="docutils literal"><span class="pre">None</span></code>, it will be assigned to the global <code class="docutils literal"><span class="pre">userManager</span></code> instance.</p>
<p>If none of the registered factories return a user manager instance, the class referenced by the <code class="docutils literal"><span class="pre">config.yaml</span></code>
entry <code class="docutils literal"><span class="pre">accessControl.userManager</span></code> will be initialized if possible, otherwise a stock
<code class="xref py py-class docutils literal"><span class="pre">FilebasedUserManager</span></code> will be instantiated, linked to the default user storage
file <code class="docutils literal"><span class="pre">~/.octoprint/users.yaml</span></code>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>components</strong> (<em>dict</em>) – System components to use for user manager instance initialization</li>
<li><strong>settings</strong> (<em>SettingsManager</em>) – The global settings manager instance to fetch configuration values from if necessary</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first">The <code class="docutils literal"><span class="pre">userManager</span></code> instance to use globally.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Return type:</th><td class="field-body"><p class="first last">UserManager subclass or None</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="helpers.html" class="btn btn-neutral float-right" title="Helpers" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="mixins.html" class="btn btn-neutral float-left" title="Mixins" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2013-2020, Gina Häußge

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Other Versions</span>
    v: 1.3.12
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl>
      <dt>Tags</dt>
      <dd><a href="https://docs.octoprint.org/en/1.4.2/plugins/hooks.html">1.4.2</a></dd>
      <dd><a href="https://docs.octoprint.org/en/1.5.0rc3/plugins/hooks.html">1.5.0rc3</a></dd>
      <dd><a href="https://docs.octoprint.org/en/1.3.12/plugins/hooks.html">1.3.12</a></dd>
    </dl>
    <dl>
      <dt>Branches</dt>
      <dd><a href="https://docs.octoprint.org/en/devel/plugins/hooks.html">devel</a></dd>
      <dd><a href="https://docs.octoprint.org/en/master/plugins/hooks.html">master</a></dd>
      <dd><a href="https://docs.octoprint.org/en/maintenance/plugins/hooks.html">maintenance</a></dd>
    </dl>
  </div>
</div>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>